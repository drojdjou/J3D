/*

J3D, a Javascript/WebGL 3D engine
Created by Bartek Drozdz <bartek@everyday3d.com>
http://www.everyday3d.com/j3d/

Version 1
Build 74 | Wed Dec 18 18:18:52 2013

Uses the following libraries:

glMatrix.js, Copyright (c) 2010 Brandon Jones
https://github.com/toji/gl-matrix

requestAnimationFrame
http://paulirish.com/2011/requestanimationframe-for-smart-animating/

*/
if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();(function(a,b){typeof exports==="object"?module.exports=b(global):typeof define==="function"&&define.amd?define([],function(){return b(a)}):b(a)})(this,function(a){function b(c){return h=c}function d(){return h=typeof Float32Array!=="undefined"?Float32Array:Array}var e={};(function(){if(typeof Float32Array!="undefined"){var c=new Float32Array(1),f=new Int32Array(c.buffer);e.invsqrt=function(a){c[0]=a;f[0]=1597463007-(f[0]>>1);var b=c[0];return b*(1.5-a*0.5*b*b)}}else e.invsqrt=function(c){return 1/
Math.sqrt(c)}})();var h=null;d();var g={};g.create=function(c){var f=new h(3);c?(f[0]=c[0],f[1]=c[1],f[2]=c[2]):f[0]=f[1]=f[2]=0;return f};g.createFrom=function(c,f,a){var b=new h(3);b[0]=c;b[1]=f;b[2]=a;return b};g.set=function(c,f,a,b){c[0]=f;c[1]=a;c[2]=b;return c};g.equal=function(c,f){return c===f||Math.abs(c[0]-f[0])<1.0E-6&&Math.abs(c[1]-f[1])<1.0E-6&&Math.abs(c[2]-f[2])<1.0E-6};g.add=function(c,f,a){if(!a||c===a)return c[0]+=f[0],c[1]+=f[1],c[2]+=f[2],c;a[0]=c[0]+f[0];a[1]=c[1]+f[1];a[2]=
c[2]+f[2];return a};g.subtract=function(c,f,a){if(!a||c===a)return c[0]-=f[0],c[1]-=f[1],c[2]-=f[2],c;a[0]=c[0]-f[0];a[1]=c[1]-f[1];a[2]=c[2]-f[2];return a};g.multiply=function(c,f,a){if(!a||c===a)return c[0]*=f[0],c[1]*=f[1],c[2]*=f[2],c;a[0]=c[0]*f[0];a[1]=c[1]*f[1];a[2]=c[2]*f[2];return a};g.negate=function(c,f){f||(f=c);f[0]=-c[0];f[1]=-c[1];f[2]=-c[2];return f};g.scale=function(c,f,a){if(!a||c===a)return c[0]*=f,c[1]*=f,c[2]*=f,c;a[0]=c[0]*f;a[1]=c[1]*f;a[2]=c[2]*f;return a};g.normalize=function(c,
f){f||(f=c);var a=c[0],b=c[1],d=c[2],e=Math.sqrt(a*a+b*b+d*d);if(e){if(e===1)return f[0]=a,f[1]=b,f[2]=d,f}else return f[0]=0,f[1]=0,f[2]=0,f;e=1/e;f[0]=a*e;f[1]=b*e;f[2]=d*e;return f};g.cross=function(c,f,a){a||(a=c);var b=c[0],d=c[1];c=c[2];var e=f[0],h=f[1];f=f[2];a[0]=d*f-c*h;a[1]=c*e-b*f;a[2]=b*h-d*e;return a};g.length=function(c){var f=c[0],a=c[1];c=c[2];return Math.sqrt(f*f+a*a+c*c)};g.squaredLength=function(c){var f=c[0],a=c[1];c=c[2];return f*f+a*a+c*c};g.dot=function(c,f){return c[0]*f[0]+
c[1]*f[1]+c[2]*f[2]};g.direction=function(c,f,a){a||(a=c);var b=c[0]-f[0],d=c[1]-f[1];c=c[2]-f[2];f=Math.sqrt(b*b+d*d+c*c);if(!f)return a[0]=0,a[1]=0,a[2]=0,a;f=1/f;a[0]=b*f;a[1]=d*f;a[2]=c*f;return a};g.lerp=function(c,f,a,b){b||(b=c);b[0]=c[0]+a*(f[0]-c[0]);b[1]=c[1]+a*(f[1]-c[1]);b[2]=c[2]+a*(f[2]-c[2]);return b};g.dist=function(c,f){var a=f[0]-c[0],b=f[1]-c[1],d=f[2]-c[2];return Math.sqrt(a*a+b*b+d*d)};var i=null,k=new h(4);g.unproject=function(c,f,a,b,d){d||(d=c);i||(i=o.create());var e=i;k[0]=
(c[0]-b[0])*2/b[2]-1;k[1]=(c[1]-b[1])*2/b[3]-1;k[2]=2*c[2]-1;k[3]=1;o.multiply(a,f,e);if(!o.inverse(e))return null;o.multiplyVec4(e,k);if(k[3]===0)return null;d[0]=k[0]/k[3];d[1]=k[1]/k[3];d[2]=k[2]/k[3];return d};var j=g.createFrom(1,0,0),l=g.createFrom(0,1,0),m=g.createFrom(0,0,1),p=g.create();g.rotationTo=function(c,f,a){a||(a=n.create());var b=g.dot(c,f);if(b>=1)n.set(u,a);else if(b<-0.999999)g.cross(j,c,p),g.length(p)<1.0E-6&&g.cross(l,c,p),g.length(p)<1.0E-6&&g.cross(m,c,p),g.normalize(p),n.fromAngleAxis(Math.PI,
p,a);else{b=Math.sqrt((1+b)*2);var d=1/b;g.cross(c,f,p);a[0]=p[0]*d;a[1]=p[1]*d;a[2]=p[2]*d;a[3]=b*0.5;n.normalize(a)}a[3]>1?a[3]=1:a[3]<-1&&(a[3]=-1);return a};g.str=function(c){return"["+c[0]+", "+c[1]+", "+c[2]+"]"};var r={};r.create=function(c){var f=new h(9);c?(f[0]=c[0],f[1]=c[1],f[2]=c[2],f[3]=c[3],f[4]=c[4],f[5]=c[5],f[6]=c[6],f[7]=c[7],f[8]=c[8]):f[0]=f[1]=f[2]=f[3]=f[4]=f[5]=f[6]=f[7]=f[8]=0;return f};r.createFrom=function(c,f,a,b,d,e,g,i,k){var j=new h(9);j[0]=c;j[1]=f;j[2]=a;j[3]=b;j[4]=
d;j[5]=e;j[6]=g;j[7]=i;j[8]=k;return j};r.determinant=function(c){var f=c[3],a=c[4],b=c[5],d=c[6],e=c[7],h=c[8];return c[0]*(h*a-b*e)+c[1]*(-h*f+b*d)+c[2]*(e*f-a*d)};r.inverse=function(c,f){var a=c[0],b=c[1],d=c[2],e=c[3],h=c[4],g=c[5],i=c[6],j=c[7],k=c[8],l=k*h-g*j,n=-k*e+g*i,o=j*e-h*i,m=a*l+b*n+d*o;if(!m)return null;m=1/m;f||(f=r.create());f[0]=l*m;f[1]=(-k*b+d*j)*m;f[2]=(g*b-d*h)*m;f[3]=n*m;f[4]=(k*a-d*i)*m;f[5]=(-g*a+d*e)*m;f[6]=o*m;f[7]=(-j*a+b*i)*m;f[8]=(h*a-b*e)*m;return f};r.multiply=function(c,
f,a){a||(a=c);var b=c[0],d=c[1],e=c[2],h=c[3],g=c[4],i=c[5],j=c[6],k=c[7];c=c[8];var l=f[0],m=f[1],n=f[2],o=f[3],p=f[4],r=f[5],q=f[6],t=f[7];f=f[8];a[0]=l*b+m*h+n*j;a[1]=l*d+m*g+n*k;a[2]=l*e+m*i+n*c;a[3]=o*b+p*h+r*j;a[4]=o*d+p*g+r*k;a[5]=o*e+p*i+r*c;a[6]=q*b+t*h+f*j;a[7]=q*d+t*g+f*k;a[8]=q*e+t*i+f*c;return a};r.multiplyVec2=function(c,f,a){a||(a=f);var b=f[0];f=f[1];a[0]=b*c[0]+f*c[3]+c[6];a[1]=b*c[1]+f*c[4]+c[7];return a};r.multiplyVec3=function(c,f,a){a||(a=f);var b=f[0],d=f[1];f=f[2];a[0]=b*c[0]+
d*c[3]+f*c[6];a[1]=b*c[1]+d*c[4]+f*c[7];a[2]=b*c[2]+d*c[5]+f*c[8];return a};r.set=function(c,f){f[0]=c[0];f[1]=c[1];f[2]=c[2];f[3]=c[3];f[4]=c[4];f[5]=c[5];f[6]=c[6];f[7]=c[7];f[8]=c[8];return f};r.equal=function(c,f){return c===f||Math.abs(c[0]-f[0])<1.0E-6&&Math.abs(c[1]-f[1])<1.0E-6&&Math.abs(c[2]-f[2])<1.0E-6&&Math.abs(c[3]-f[3])<1.0E-6&&Math.abs(c[4]-f[4])<1.0E-6&&Math.abs(c[5]-f[5])<1.0E-6&&Math.abs(c[6]-f[6])<1.0E-6&&Math.abs(c[7]-f[7])<1.0E-6&&Math.abs(c[8]-f[8])<1.0E-6};r.identity=function(c){c||
(c=r.create());c[0]=1;c[1]=0;c[2]=0;c[3]=0;c[4]=1;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return c};r.transpose=function(c,f){if(!f||c===f){var a=c[1],b=c[2],d=c[5];c[1]=c[3];c[2]=c[6];c[3]=a;c[5]=c[7];c[6]=b;c[7]=d;return c}f[0]=c[0];f[1]=c[3];f[2]=c[6];f[3]=c[1];f[4]=c[4];f[5]=c[7];f[6]=c[2];f[7]=c[5];f[8]=c[8];return f};r.toMat4=function(c,f){f||(f=o.create());f[15]=1;f[14]=0;f[13]=0;f[12]=0;f[11]=0;f[10]=c[8];f[9]=c[7];f[8]=c[6];f[7]=0;f[6]=c[5];f[5]=c[4];f[4]=c[3];f[3]=0;f[2]=c[2];f[1]=c[1];f[0]=c[0];return f};
r.str=function(c){return"["+c[0]+", "+c[1]+", "+c[2]+", "+c[3]+", "+c[4]+", "+c[5]+", "+c[6]+", "+c[7]+", "+c[8]+"]"};var o={};o.create=function(c){J3D&&J3D.Performance&&J3D.Performance.numMatrices++;var f=new h(16);c&&(f[0]=c[0],f[1]=c[1],f[2]=c[2],f[3]=c[3],f[4]=c[4],f[5]=c[5],f[6]=c[6],f[7]=c[7],f[8]=c[8],f[9]=c[9],f[10]=c[10],f[11]=c[11],f[12]=c[12],f[13]=c[13],f[14]=c[14],f[15]=c[15]);return f};o.createFrom=function(c,f,a,b,d,e,g,i,j,k,l,m,n,o,p,r){var q=new h(16);q[0]=c;q[1]=f;q[2]=a;q[3]=b;
q[4]=d;q[5]=e;q[6]=g;q[7]=i;q[8]=j;q[9]=k;q[10]=l;q[11]=m;q[12]=n;q[13]=o;q[14]=p;q[15]=r;return q};o.set=function(c,f){f[0]=c[0];f[1]=c[1];f[2]=c[2];f[3]=c[3];f[4]=c[4];f[5]=c[5];f[6]=c[6];f[7]=c[7];f[8]=c[8];f[9]=c[9];f[10]=c[10];f[11]=c[11];f[12]=c[12];f[13]=c[13];f[14]=c[14];f[15]=c[15];return f};o.equal=function(c,f){return c===f||Math.abs(c[0]-f[0])<1.0E-6&&Math.abs(c[1]-f[1])<1.0E-6&&Math.abs(c[2]-f[2])<1.0E-6&&Math.abs(c[3]-f[3])<1.0E-6&&Math.abs(c[4]-f[4])<1.0E-6&&Math.abs(c[5]-f[5])<1.0E-6&&
Math.abs(c[6]-f[6])<1.0E-6&&Math.abs(c[7]-f[7])<1.0E-6&&Math.abs(c[8]-f[8])<1.0E-6&&Math.abs(c[9]-f[9])<1.0E-6&&Math.abs(c[10]-f[10])<1.0E-6&&Math.abs(c[11]-f[11])<1.0E-6&&Math.abs(c[12]-f[12])<1.0E-6&&Math.abs(c[13]-f[13])<1.0E-6&&Math.abs(c[14]-f[14])<1.0E-6&&Math.abs(c[15]-f[15])<1.0E-6};o.identity=function(c){c||(c=o.create());c[0]=1;c[1]=0;c[2]=0;c[3]=0;c[4]=0;c[5]=1;c[6]=0;c[7]=0;c[8]=0;c[9]=0;c[10]=1;c[11]=0;c[12]=0;c[13]=0;c[14]=0;c[15]=1;return c};o.transpose=function(c,f){if(!f||c===f){var a=
c[1],b=c[2],d=c[3],e=c[6],h=c[7],g=c[11];c[1]=c[4];c[2]=c[8];c[3]=c[12];c[4]=a;c[6]=c[9];c[7]=c[13];c[8]=b;c[9]=e;c[11]=c[14];c[12]=d;c[13]=h;c[14]=g;return c}f[0]=c[0];f[1]=c[4];f[2]=c[8];f[3]=c[12];f[4]=c[1];f[5]=c[5];f[6]=c[9];f[7]=c[13];f[8]=c[2];f[9]=c[6];f[10]=c[10];f[11]=c[14];f[12]=c[3];f[13]=c[7];f[14]=c[11];f[15]=c[15];return f};o.determinant=function(c){var f=c[0],a=c[1],b=c[2],d=c[3],e=c[4],h=c[5],g=c[6],i=c[7],j=c[8],k=c[9],l=c[10],m=c[11],n=c[12],o=c[13],p=c[14];c=c[15];return n*k*g*
d-j*o*g*d-n*h*l*d+e*o*l*d+j*h*p*d-e*k*p*d-n*k*b*i+j*o*b*i+n*a*l*i-f*o*l*i-j*a*p*i+f*k*p*i+n*h*b*m-e*o*b*m-n*a*g*m+f*o*g*m+e*a*p*m-f*h*p*m-j*h*b*c+e*k*b*c+j*a*g*c-f*k*g*c-e*a*l*c+f*h*l*c};o.inverse=function(c,f){f||(f=c);var a=c[0],b=c[1],d=c[2],e=c[3],h=c[4],g=c[5],i=c[6],j=c[7],k=c[8],l=c[9],m=c[10],n=c[11],o=c[12],p=c[13],q=c[14],r=c[15],t=a*g-b*h,u=a*i-d*h,w=a*j-e*h,x=b*i-d*g,v=b*j-e*g,z=d*j-e*i,A=k*p-l*o,B=k*q-m*o,C=k*r-n*o,D=l*q-m*p,E=l*r-n*p,F=m*r-n*q,y=t*F-u*E+w*D+x*C-v*B+z*A;if(!y)return null;
y=1/y;f[0]=(g*F-i*E+j*D)*y;f[1]=(-b*F+d*E-e*D)*y;f[2]=(p*z-q*v+r*x)*y;f[3]=(-l*z+m*v-n*x)*y;f[4]=(-h*F+i*C-j*B)*y;f[5]=(a*F-d*C+e*B)*y;f[6]=(-o*z+q*w-r*u)*y;f[7]=(k*z-m*w+n*u)*y;f[8]=(h*E-g*C+j*A)*y;f[9]=(-a*E+b*C-e*A)*y;f[10]=(o*v-p*w+r*t)*y;f[11]=(-k*v+l*w-n*t)*y;f[12]=(-h*D+g*B-i*A)*y;f[13]=(a*D-b*B+d*A)*y;f[14]=(-o*x+p*u-q*t)*y;f[15]=(k*x-l*u+m*t)*y;return f};o.toRotationMat=function(c,f){f||(f=o.create());f[0]=c[0];f[1]=c[1];f[2]=c[2];f[3]=c[3];f[4]=c[4];f[5]=c[5];f[6]=c[6];f[7]=c[7];f[8]=c[8];
f[9]=c[9];f[10]=c[10];f[11]=c[11];f[12]=0;f[13]=0;f[14]=0;f[15]=1;return f};o.toMat3=function(c,f){f||(f=r.create());f[0]=c[0];f[1]=c[1];f[2]=c[2];f[3]=c[4];f[4]=c[5];f[5]=c[6];f[6]=c[8];f[7]=c[9];f[8]=c[10];return f};o.toInverseMat3=function(c,f){var a=c[0],b=c[1],d=c[2],e=c[4],h=c[5],g=c[6],i=c[8],j=c[9],k=c[10],l=k*h-g*j,m=-k*e+g*i,n=j*e-h*i,o=a*l+b*m+d*n;if(!o)return null;o=1/o;f||(f=r.create());f[0]=l*o;f[1]=(-k*b+d*j)*o;f[2]=(g*b-d*h)*o;f[3]=m*o;f[4]=(k*a-d*i)*o;f[5]=(-g*a+d*e)*o;f[6]=n*o;f[7]=
(-j*a+b*i)*o;f[8]=(h*a-b*e)*o;return f};o.multiply=function(c,f,a){a||(a=c);var b=c[0],d=c[1],e=c[2],h=c[3],g=c[4],i=c[5],j=c[6],k=c[7],l=c[8],o=c[9],m=c[10],n=c[11],p=c[12],q=c[13],r=c[14];c=c[15];var t=f[0],u=f[1],w=f[2],x=f[3];a[0]=t*b+u*g+w*l+x*p;a[1]=t*d+u*i+w*o+x*q;a[2]=t*e+u*j+w*m+x*r;a[3]=t*h+u*k+w*n+x*c;t=f[4];u=f[5];w=f[6];x=f[7];a[4]=t*b+u*g+w*l+x*p;a[5]=t*d+u*i+w*o+x*q;a[6]=t*e+u*j+w*m+x*r;a[7]=t*h+u*k+w*n+x*c;t=f[8];u=f[9];w=f[10];x=f[11];a[8]=t*b+u*g+w*l+x*p;a[9]=t*d+u*i+w*o+x*q;a[10]=
t*e+u*j+w*m+x*r;a[11]=t*h+u*k+w*n+x*c;t=f[12];u=f[13];w=f[14];x=f[15];a[12]=t*b+u*g+w*l+x*p;a[13]=t*d+u*i+w*o+x*q;a[14]=t*e+u*j+w*m+x*r;a[15]=t*h+u*k+w*n+x*c;return a};o.multiplyVec3=function(c,f,a){a||(a=f);var b=f[0],d=f[1];f=f[2];a[0]=c[0]*b+c[4]*d+c[8]*f+c[12];a[1]=c[1]*b+c[5]*d+c[9]*f+c[13];a[2]=c[2]*b+c[6]*d+c[10]*f+c[14];return a};o.multiplyVec4=function(c,f,a){a||(a=f);var b=f[0],d=f[1],e=f[2];f=f[3];a[0]=c[0]*b+c[4]*d+c[8]*e+c[12]*f;a[1]=c[1]*b+c[5]*d+c[9]*e+c[13]*f;a[2]=c[2]*b+c[6]*d+c[10]*
e+c[14]*f;a[3]=c[3]*b+c[7]*d+c[11]*e+c[15]*f;return a};o.translate=function(c,f,a){var b=f[0],d=f[1];f=f[2];var e,h,g,i,j,k,l,o,m,n,p,q;if(!a||c===a)return c[12]=c[0]*b+c[4]*d+c[8]*f+c[12],c[13]=c[1]*b+c[5]*d+c[9]*f+c[13],c[14]=c[2]*b+c[6]*d+c[10]*f+c[14],c[15]=c[3]*b+c[7]*d+c[11]*f+c[15],c;e=c[0];h=c[1];g=c[2];i=c[3];j=c[4];k=c[5];l=c[6];o=c[7];m=c[8];n=c[9];p=c[10];q=c[11];a[0]=e;a[1]=h;a[2]=g;a[3]=i;a[4]=j;a[5]=k;a[6]=l;a[7]=o;a[8]=m;a[9]=n;a[10]=p;a[11]=q;a[12]=e*b+j*d+m*f+c[12];a[13]=h*b+k*d+
n*f+c[13];a[14]=g*b+l*d+p*f+c[14];a[15]=i*b+o*d+q*f+c[15];return a};o.extractTranslation=function(c,f){f[0]=c[12];f[1]=c[13];f[2]=c[14]};o.scale=function(c,f,a){var b=f[0],d=f[1];f=f[2];if(!a||c===a)return c[0]*=b,c[1]*=b,c[2]*=b,c[3]*=b,c[4]*=d,c[5]*=d,c[6]*=d,c[7]*=d,c[8]*=f,c[9]*=f,c[10]*=f,c[11]*=f,c;a[0]=c[0]*b;a[1]=c[1]*b;a[2]=c[2]*b;a[3]=c[3]*b;a[4]=c[4]*d;a[5]=c[5]*d;a[6]=c[6]*d;a[7]=c[7]*d;a[8]=c[8]*f;a[9]=c[9]*f;a[10]=c[10]*f;a[11]=c[11]*f;a[12]=c[12];a[13]=c[13];a[14]=c[14];a[15]=c[15];
return a};o.rotate=function(c,f,a,b){var d=a[0],e=a[1];a=a[2];var h=Math.sqrt(d*d+e*e+a*a),g,i,j,k,l,o,m,n,p,q,r,t,u,w,x,v,z,A,B,C;if(!h)return null;h!==1&&(h=1/h,d*=h,e*=h,a*=h);g=Math.sin(f);i=Math.cos(f);j=1-i;f=c[0];h=c[1];k=c[2];l=c[3];o=c[4];m=c[5];n=c[6];p=c[7];q=c[8];r=c[9];t=c[10];u=c[11];w=d*d*j+i;x=e*d*j+a*g;v=a*d*j-e*g;z=d*e*j-a*g;A=e*e*j+i;B=a*e*j+d*g;C=d*a*j+e*g;d=e*a*j-d*g;e=a*a*j+i;b?c!==b&&(b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15]):b=c;b[0]=f*w+o*x+q*v;b[1]=h*w+m*x+r*v;b[2]=
k*w+n*x+t*v;b[3]=l*w+p*x+u*v;b[4]=f*z+o*A+q*B;b[5]=h*z+m*A+r*B;b[6]=k*z+n*A+t*B;b[7]=l*z+p*A+u*B;b[8]=f*C+o*d+q*e;b[9]=h*C+m*d+r*e;b[10]=k*C+n*d+t*e;b[11]=l*C+p*d+u*e;return b};o.rotateX=function(c,f,a){var b=Math.sin(f);f=Math.cos(f);var d=c[4],e=c[5],h=c[6],g=c[7],i=c[8],j=c[9],k=c[10],l=c[11];a?c!==a&&(a[0]=c[0],a[1]=c[1],a[2]=c[2],a[3]=c[3],a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]):a=c;a[4]=d*f+i*b;a[5]=e*f+j*b;a[6]=h*f+k*b;a[7]=g*f+l*b;a[8]=d*-b+i*f;a[9]=e*-b+j*f;a[10]=h*-b+k*f;a[11]=
g*-b+l*f;return a};o.rotateY=function(c,f,a){var b=Math.sin(f);f=Math.cos(f);var d=c[0],e=c[1],h=c[2],g=c[3],i=c[8],j=c[9],k=c[10],l=c[11];a?c!==a&&(a[4]=c[4],a[5]=c[5],a[6]=c[6],a[7]=c[7],a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]):a=c;a[0]=d*f+i*-b;a[1]=e*f+j*-b;a[2]=h*f+k*-b;a[3]=g*f+l*-b;a[8]=d*b+i*f;a[9]=e*b+j*f;a[10]=h*b+k*f;a[11]=g*b+l*f;return a};o.rotateZ=function(c,a,b){var d=Math.sin(a);a=Math.cos(a);var e=c[0],h=c[1],g=c[2],i=c[3],j=c[4],k=c[5],l=c[6],o=c[7];b?c!==b&&(b[8]=c[8],b[9]=
c[9],b[10]=c[10],b[11]=c[11],b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15]):b=c;b[0]=e*a+j*d;b[1]=h*a+k*d;b[2]=g*a+l*d;b[3]=i*a+o*d;b[4]=e*-d+j*a;b[5]=h*-d+k*a;b[6]=g*-d+l*a;b[7]=i*-d+o*a;return b};o.frustum=function(c,a,b,d,e,h,g){g||(g=o.create());var i=a-c,j=d-b,k=h-e;g[0]=e*2/i;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=e*2/j;g[6]=0;g[7]=0;g[8]=(a+c)/i;g[9]=(d+b)/j;g[10]=-(h+e)/k;g[11]=-1;g[12]=0;g[13]=0;g[14]=-(h*e*2)/k;g[15]=0;return g};o.perspective=function(c,a,b,d,e){c=b*Math.tan(c*Math.PI/360);
a*=c;return o.frustum(-a,a,-c,c,b,d,e)};o.ortho=function(c,a,b,d,e,h,g){g||(g=o.create());var i=a-c,j=d-b,k=h-e;g[0]=2/i;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2/j;g[6]=0;g[7]=0;g[8]=0;g[9]=0;g[10]=-2/k;g[11]=0;g[12]=-(c+a)/i;g[13]=-(d+b)/j;g[14]=-(h+e)/k;g[15]=1;return g};o.lookAt=function(c,a,b,d){d||(d=o.create());var e,h,g,i,j,k,l,m,n=c[0],p=c[1];c=c[2];g=b[0];i=b[1];h=b[2];l=a[0];b=a[1];e=a[2];if(n===l&&p===b&&c===e)return o.identity(d);a=n-l;b=p-b;l=c-e;m=1/Math.sqrt(a*a+b*b+l*l);a*=m;b*=m;l*=m;e=
i*l-h*b;h=h*a-g*l;g=g*b-i*a;(m=Math.sqrt(e*e+h*h+g*g))?(m=1/m,e*=m,h*=m,g*=m):g=h=e=0;i=b*g-l*h;j=l*e-a*g;k=a*h-b*e;(m=Math.sqrt(i*i+j*j+k*k))?(m=1/m,i*=m,j*=m,k*=m):k=j=i=0;d[0]=e;d[1]=i;d[2]=a;d[3]=0;d[4]=h;d[5]=j;d[6]=b;d[7]=0;d[8]=g;d[9]=k;d[10]=l;d[11]=0;d[12]=-(e*n+h*p+g*c);d[13]=-(i*n+j*p+k*c);d[14]=-(a*n+b*p+l*c);d[15]=1;return d};o.lookAt2=function(c,a,b,d){c=c.sub(a).norm();if(c.mag()===0)c.z=1;a=v3.cross(b,c).norm();a.mag()===0&&(c.x+=1.0E-4,a=v3.cross(b,c).norm());b=v3.cross(c,a);d[0]=
a.x;d[4]=b.x;d[8]=c.x;d[1]=a.y;d[5]=b.y;d[9]=c.y;d[2]=a.z;d[6]=b.z;d[10]=c.z;return this};o.fromRotationTranslation=function(c,a,b){b||(b=o.create());var d=c[0],e=c[1],h=c[2],g=c[3],i=d+d,j=e+e,k=h+h;c=d*i;var l=d*j;d*=k;var m=e*j;e*=k;h*=k;i*=g;j*=g;g*=k;b[0]=1-(m+h);b[1]=l+g;b[2]=d-j;b[3]=0;b[4]=l-g;b[5]=1-(c+h);b[6]=e+i;b[7]=0;b[8]=d+j;b[9]=e-i;b[10]=1-(c+m);b[11]=0;b[12]=a[0];b[13]=a[1];b[14]=a[2];b[15]=1;return b};o.fromRotationQTranslation=function(c,a,b,d,e,h,g,i,j,k,l){o.identity(c);var m=
h*h,n=g*g,p=i*i;c[0]=(1-2*n-2*p)*j;c[1]=(2*h*g-2*i*e)*j;c[2]=(2*h*i+2*g*e)*j;c[4]=(2*h*g+2*i*e)*k;c[5]=(1-2*m-2*p)*k;c[6]=(2*g*i-2*h*e)*k;c[8]=(2*h*i-2*g*e)*l;c[9]=(2*g*i+2*h*e)*l;c[10]=(1-2*m-2*n)*l;c[12]=a;c[13]=b;c[14]=d;return c};o.str=function(c){return"["+c[0]+", "+c[1]+", "+c[2]+", "+c[3]+", "+c[4]+", "+c[5]+", "+c[6]+", "+c[7]+", "+c[8]+", "+c[9]+", "+c[10]+", "+c[11]+", "+c[12]+", "+c[13]+", "+c[14]+", "+c[15]+"]"};var n={};n.create=function(c){var a=new h(4);c?(a[0]=c[0],a[1]=c[1],a[2]=
c[2],a[3]=c[3]):a[0]=a[1]=a[2]=a[3]=0;return a};n.createFrom=function(c,a,b,d){var e=new h(4);e[0]=c;e[1]=a;e[2]=b;e[3]=d;return e};n.set=function(c,a){a[0]=c[0];a[1]=c[1];a[2]=c[2];a[3]=c[3];return a};n.equal=function(c,a){return c===a||Math.abs(c[0]-a[0])<1.0E-6&&Math.abs(c[1]-a[1])<1.0E-6&&Math.abs(c[2]-a[2])<1.0E-6&&Math.abs(c[3]-a[3])<1.0E-6};n.identity=function(c){c||(c=n.create());c[0]=0;c[1]=0;c[2]=0;c[3]=1;return c};var u=n.identity();n.calculateW=function(c,a){var b=c[0],d=c[1],e=c[2];if(!a||
c===a)return c[3]=-Math.sqrt(Math.abs(1-b*b-d*d-e*e)),c;a[0]=b;a[1]=d;a[2]=e;a[3]=-Math.sqrt(Math.abs(1-b*b-d*d-e*e));return a};n.dot=function(c,a){return c[0]*a[0]+c[1]*a[1]+c[2]*a[2]+c[3]*a[3]};n.inverse=function(c,a){var b=c[0],d=c[1],e=c[2],h=c[3];b=(b=b*b+d*d+e*e+h*h)?1/b:0;if(!a||c===a)return c[0]*=-b,c[1]*=-b,c[2]*=-b,c[3]*=b,c;a[0]=-c[0]*b;a[1]=-c[1]*b;a[2]=-c[2]*b;a[3]=c[3]*b;return a};n.conjugate=function(c,a){if(!a||c===a)return c[0]*=-1,c[1]*=-1,c[2]*=-1,c;a[0]=-c[0];a[1]=-c[1];a[2]=-c[2];
a[3]=c[3];return a};n.length=function(c){var a=c[0],b=c[1],d=c[2];c=c[3];return Math.sqrt(a*a+b*b+d*d+c*c)};n.normalize=function(c,a){a||(a=c);var b=c[0],d=c[1],e=c[2],h=c[3],g=Math.sqrt(b*b+d*d+e*e+h*h);if(g===0)return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a;g=1/g;a[0]=b*g;a[1]=d*g;a[2]=e*g;a[3]=h*g;return a};n.add=function(c,a,b){if(!b||c===b)return c[0]+=a[0],c[1]+=a[1],c[2]+=a[2],c[3]+=a[3],c;b[0]=c[0]+a[0];b[1]=c[1]+a[1];b[2]=c[2]+a[2];b[3]=c[3]+a[3];return b};n.multiply=function(c,a,b){b||(b=c);var d=
c[0],e=c[1],h=c[2];c=c[3];var g=a[0],i=a[1],j=a[2];a=a[3];b[0]=d*a+c*g+e*j-h*i;b[1]=e*a+c*i+h*g-d*j;b[2]=h*a+c*j+d*i-e*g;b[3]=c*a-d*g-e*i-h*j;return b};n.multiplyVec3=function(c,a,b){b||(b=a);var d=a[0],e=a[1],h=a[2];a=c[0];var g=c[1],i=c[2];c=c[3];var j=c*d+g*h-i*e,k=c*e+i*d-a*h,l=c*h+a*e-g*d;d=-a*d-g*e-i*h;b[0]=j*c+d*-a+k*-i-l*-g;b[1]=k*c+d*-g+l*-a-j*-i;b[2]=l*c+d*-i+j*-g-k*-a;return b};n.scale=function(c,a,b){if(!b||c===b)return c[0]*=a,c[1]*=a,c[2]*=a,c[3]*=a,c;b[0]=c[0]*a;b[1]=c[1]*a;b[2]=c[2]*
a;b[3]=c[3]*a;return b};n.toMat3=function(c,a){a||(a=r.create());var b=c[0],d=c[1],e=c[2],h=c[3],g=b+b,i=d+d,j=e+e,k=b*g,l=b*i;b*=j;var m=d*i;d*=j;e*=j;g*=h;i*=h;h*=j;a[0]=1-(m+e);a[1]=l+h;a[2]=b-i;a[3]=l-h;a[4]=1-(k+e);a[5]=d+g;a[6]=b+i;a[7]=d-g;a[8]=1-(k+m);return a};n.toMat4=function(c,a){a||(a=o.create());var b=c[0],d=c[1],e=c[2],h=c[3],g=b+b,i=d+d,j=e+e,k=b*g,l=b*i;b*=j;var m=d*i;d*=j;e*=j;g*=h;i*=h;h*=j;a[0]=1-(m+e);a[1]=l+h;a[2]=b-i;a[3]=0;a[4]=l-h;a[5]=1-(k+e);a[6]=d+g;a[7]=0;a[8]=b+i;a[9]=
d-g;a[10]=1-(k+m);a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};n.slerp=function(c,a,b,d){d||(d=c);var e=c[0]*a[0]+c[1]*a[1]+c[2]*a[2]+c[3]*a[3],h,g;if(Math.abs(e)>=1)return d!==c&&(d[0]=c[0],d[1]=c[1],d[2]=c[2],d[3]=c[3]),d;h=Math.acos(e);g=Math.sqrt(1-e*e);if(Math.abs(g)<0.0010)return d[0]=c[0]*0.5+a[0]*0.5,d[1]=c[1]*0.5+a[1]*0.5,d[2]=c[2]*0.5+a[2]*0.5,d[3]=c[3]*0.5+a[3]*0.5,d;e=Math.sin((1-b)*h)/g;b=Math.sin(b*h)/g;d[0]=c[0]*e+a[0]*b;d[1]=c[1]*e+a[1]*b;d[2]=c[2]*e+a[2]*b;d[3]=c[3]*e+a[3]*b;
return d};n.fromRotationMatrix=function(c,a){a||(a=n.create());var b=c[0]+c[4]+c[8],d;if(b>0)d=Math.sqrt(b+1),a[3]=0.5*d,d=0.5/d,a[0]=(c[7]-c[5])*d,a[1]=(c[2]-c[6])*d,a[2]=(c[3]-c[1])*d;else{d=n.fromRotationMatrix.s_iNext=n.fromRotationMatrix.s_iNext||[1,2,0];b=0;c[4]>c[0]&&(b=1);c[8]>c[b*3+b]&&(b=2);var e=d[b],h=d[e];d=Math.sqrt(c[b*3+b]-c[e*3+e]-c[h*3+h]+1);a[b]=0.5*d;d=0.5/d;a[3]=(c[h*3+e]-c[e*3+h])*d;a[e]=(c[e*3+b]+c[b*3+e])*d;a[h]=(c[h*3+b]+c[b*3+h])*d}return a};r.toQuat4=n.fromRotationMatrix;
(function(){var c=r.create();n.fromAxes=function(a,b,d,e){c[0]=b[0];c[3]=b[1];c[6]=b[2];c[1]=d[0];c[4]=d[1];c[7]=d[2];c[2]=a[0];c[5]=a[1];c[8]=a[2];return n.fromRotationMatrix(c,e)}})();n.identity=function(c){c||(c=n.create());c[0]=0;c[1]=0;c[2]=0;c[3]=1;return c};n.fromAngleAxis=function(c,a,b){b||(b=n.create());c*=0.5;var d=Math.sin(c);b[3]=Math.cos(c);b[0]=d*a[0];b[1]=d*a[1];b[2]=d*a[2];return b};n.toAngleAxis=function(c,a){a||(a=c);var b=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];b>0?(a[3]=2*Math.acos(c[3]),
b=e.invsqrt(b),a[0]=c[0]*b,a[1]=c[1]*b,a[2]=c[2]*b):(a[3]=0,a[0]=1,a[1]=0,a[2]=0);return a};n.fromEuler=function(c,a,b,d){d=d||n.create();var e=Math.cos(0.5*b),h=Math.cos(0.5*a),g=Math.cos(0.5*c);b=Math.sin(0.5*b);a=Math.sin(0.5*a);c=Math.sin(0.5*c);d[3]=e*h*g+b*a*c;d[0]=e*h*c-b*a*g;d[1]=e*a*g+b*h*c;d[2]=b*h*g-e*a*c;return d};n.str=function(c){return"["+c[0]+", "+c[1]+", "+c[2]+", "+c[3]+"]"};var q={};q.create=function(c){var a=new h(2);c?(a[0]=c[0],a[1]=c[1]):(a[0]=0,a[1]=0);return a};q.createFrom=
function(c,a){var b=new h(2);b[0]=c;b[1]=a;return b};q.add=function(c,a,b){b||(b=a);b[0]=c[0]+a[0];b[1]=c[1]+a[1];return b};q.subtract=function(c,a,b){b||(b=a);b[0]=c[0]-a[0];b[1]=c[1]-a[1];return b};q.multiply=function(a,b,d){d||(d=b);d[0]=a[0]*b[0];d[1]=a[1]*b[1];return d};q.divide=function(a,b,d){d||(d=b);d[0]=a[0]/b[0];d[1]=a[1]/b[1];return d};q.scale=function(a,b,d){d||(d=a);d[0]=a[0]*b;d[1]=a[1]*b;return d};q.dist=function(a,b){var d=b[0]-a[0],e=b[1]-a[1];return Math.sqrt(d*d+e*e)};q.set=function(a,
b){b[0]=a[0];b[1]=a[1];return b};q.equal=function(a,b){return a===b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<1.0E-6};q.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];return b};q.normalize=function(a,b){b||(b=a);var d=a[0]*a[0]+a[1]*a[1];d>0?(d=Math.sqrt(d),b[0]=a[0]/d,b[1]=a[1]/d):b[0]=b[1]=0;return b};q.cross=function(a,b,d){a=a[0]*b[1]-a[1]*b[0];if(!d)return a;d[0]=d[1]=0;d[2]=a;return d};q.length=function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)};q.squaredLength=function(a){var b=
a[0];a=a[1];return b*b+a*a};q.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};q.direction=function(a,b,d){d||(d=a);var e=a[0]-b[0];a=a[1]-b[1];b=e*e+a*a;if(!b)return d[0]=0,d[1]=0,d[2]=0,d;b=1/Math.sqrt(b);d[0]=e*b;d[1]=a*b;return d};q.lerp=function(a,b,d,e){e||(e=a);e[0]=a[0]+d*(b[0]-a[0]);e[1]=a[1]+d*(b[1]-a[1]);return e};q.str=function(a){return"["+a[0]+", "+a[1]+"]"};var t={};t.create=function(a){var b=new h(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b};t.createFrom=
function(a,b,d,e){var g=new h(4);g[0]=a;g[1]=b;g[2]=d;g[3]=e;return g};t.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};t.equal=function(a,b){return a===b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<1.0E-6&&Math.abs(a[2]-b[2])<1.0E-6&&Math.abs(a[3]-b[3])<1.0E-6};t.identity=function(a){a||(a=t.create());a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a};t.transpose=function(a,b){if(!b||a===b){var d=a[1];a[1]=a[2];a[2]=d;return a}b[0]=a[0];b[1]=a[2];b[2]=a[1];b[3]=a[3];return b};t.determinant=
function(a){return a[0]*a[3]-a[2]*a[1]};t.inverse=function(a,b){b||(b=a);var d=a[0],e=a[1],h=a[2],g=a[3],i=d*g-h*e;if(!i)return null;i=1/i;b[0]=g*i;b[1]=-e*i;b[2]=-h*i;b[3]=d*i;return b};t.multiply=function(a,b,d){d||(d=a);var e=a[0],h=a[1],g=a[2];a=a[3];d[0]=e*b[0]+h*b[2];d[1]=e*b[1]+h*b[3];d[2]=g*b[0]+a*b[2];d[3]=g*b[1]+a*b[3];return d};t.rotate=function(a,b,d){d||(d=a);var e=a[0],h=a[1],g=a[2];a=a[3];var i=Math.sin(b);b=Math.cos(b);d[0]=e*b+h*i;d[1]=e*-i+h*b;d[2]=g*b+a*i;d[3]=g*-i+a*b;return d};
t.multiplyVec2=function(a,b,d){d||(d=b);var e=b[0];b=b[1];d[0]=e*a[0]+b*a[1];d[1]=e*a[2]+b*a[3];return d};t.scale=function(a,b,d){d||(d=a);var e=a[1],h=a[2],g=a[3],i=b[0];b=b[1];d[0]=a[0]*i;d[1]=e*b;d[2]=h*i;d[3]=g*b;return d};t.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var v={};v.create=function(a){var b=new h(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=0,b[2]=0,b[3]=0);return b};v.createFrom=function(a,b,d,e){var g=new h(4);g[0]=a;g[1]=b;g[2]=d;g[3]=e;return g};
v.add=function(a,b,d){d||(d=b);d[0]=a[0]+b[0];d[1]=a[1]+b[1];d[2]=a[2]+b[2];d[3]=a[3]+b[3];return d};v.subtract=function(a,b,d){d||(d=b);d[0]=a[0]-b[0];d[1]=a[1]-b[1];d[2]=a[2]-b[2];d[3]=a[3]-b[3];return d};v.multiply=function(a,b,d){d||(d=b);d[0]=a[0]*b[0];d[1]=a[1]*b[1];d[2]=a[2]*b[2];d[3]=a[3]*b[3];return d};v.divide=function(a,b,d){d||(d=b);d[0]=a[0]/b[0];d[1]=a[1]/b[1];d[2]=a[2]/b[2];d[3]=a[3]/b[3];return d};v.scale=function(a,b,d){d||(d=a);d[0]=a[0]*b;d[1]=a[1]*b;d[2]=a[2]*b;d[3]=a[3]*b;return d};
v.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};v.equal=function(a,b){return a===b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<1.0E-6&&Math.abs(a[2]-b[2])<1.0E-6&&Math.abs(a[3]-b[3])<1.0E-6};v.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=-a[3];return b};v.length=function(a){var b=a[0],d=a[1],e=a[2];a=a[3];return Math.sqrt(b*b+d*d+e*e+a*a)};v.squaredLength=function(a){var b=a[0],d=a[1],e=a[2];a=a[3];return b*b+d*d+e*e+a*a};v.lerp=function(a,b,d,e){e||
(e=a);e[0]=a[0]+d*(b[0]-a[0]);e[1]=a[1]+d*(b[1]-a[1]);e[2]=a[2]+d*(b[2]-a[2]);e[3]=a[3]+d*(b[3]-a[3]);return e};v.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};if(a)a.glMatrixArrayType=h,a.MatrixArray=h,a.setMatrixArrayType=b,a.determineMatrixArrayType=d,a.glMath=e,a.vec2=q,a.vec3=g,a.vec4=v,a.mat2=t,a.mat3=r,a.mat4=o,a.quat4=n;return{glMatrixArrayType:h,MatrixArray:h,setMatrixArrayType:b,determineMatrixArrayType:d,glMath:e,vec2:q,vec3:g,vec4:v,mat2:t,mat3:r,mat4:o,quat4:n}});var J3D={};J3D.VERSION=1;J3D.BUILD=74;J3D.getVersion=function(){return"Version "+J3D.VERSION+" | Build "+J3D.BUILD};J3D.debug=!0;J3D.LightmapAtlas=[];J3D.SHADER_MAX_LIGHTS=4;J3D.RENDER_AS_OPAQUE=0;J3D.RENDER_AS_TRANSPARENT=1;J3D.Animation=function(a){var b=!1,d=0,e=0,h=0;this.play=function(){d=J3D.Time.time;e=0;b=!0;h=0};this.animateTransform=function(i){if(b){e=J3D.Time.time-d;if(a.wrapMode==J3D.Animation.ONCE){if(e>a.length){b=!1;return}}else if(a.wrapMode==J3D.Animation.LOOP){var k=e/a.length|0;k>h&&(h=k);e%=a.length}k=e/a.samplingRate|0;var j=k==a.numSamples-1?0:k+1,l=e%a.samplingRate/a.samplingRate,m=a.properties,p=i.position;if(m.px)p.x=g("px",k,j,l);if(m.py)p.y=g("py",k,j,l);if(m.pz)p.z=g("pz",k,j,l);if(a.quaternions)i=
i.rotationq,m.rx&&(i[0]=g("rx",k,j,l)),m.ry&&(i[1]=g("ry",k,j,l)),m.rz&&(i[2]=g("rz",k,j,l)),m.rw&&(i[3]=g("rw",k,j,l));else{i=i.rotation;if(m.rx)i.x=g("rx",k,j,0);if(m.ry)i.y=g("ry",k,j,0);if(m.rz)i.z=g("rz",k,j,0)}}};var g=function(b,d,e,h){var g=a.properties;return g[b][d]+(g[b][e]-g[b][d])*h};this.animateShader=function(){};a.autoPlay&&this.play()};J3D.Animation.PX="px";J3D.Animation.PY="py";J3D.Animation.PX="pz";J3D.Animation.RX="rx";J3D.Animation.RY="ry";J3D.Animation.RZ="rz";
J3D.Animation.SX="sx";J3D.Animation.SY="sy";J3D.Animation.SZ="sz";J3D.Animation.QX="qx";J3D.Animation.QY="qy";J3D.Animation.QZ="qz";J3D.Animation.QW="qw";J3D.Animation.ONCE="once";J3D.Animation.LOOP="loop";J3D.AssetLoader=function(){function a(a){h--;g&&g(1-h/e.length);h<=0&&a(d.assets)}function b(b,d){b||(b={});var e=b.onLoad;b.onLoad=function(){a(d);e&&e()};return b}var d=this,e=[],h,g=null;this.assets={};this.addTexture=function(a,b,d){e.push({name:a,type:"texture",source:b,params:d||null})};this.addCubemap=function(a,b,d){e.push({name:a,type:"cubemap",faces:b,params:d||null})};this.addShader=function(a,b){e.push({name:a,type:"shader",path:b})};this.addJSON=function(a,b){e.push({name:a,type:"json",
path:b})};this.addPlainText=function(a,b){e.push({name:a,type:"text",path:b})};this.addImage=function(a,b){e.push({name:a,type:"image",path:b})};this.load=function(i,k){g=k;h=e.length;var j=a,l;for(l in e){var m=e[l];switch(m.type){case "texture":this.assets[m.name]=new J3D.Texture(m.source,b(m.params,i));break;case "cubemap":this.assets[m.name]=new J3D.Cubemap(m.faces,b(m.params,i));break;case "shader":var p=function(a){return function(b){d.assets[a]=b;j(i)}}(m.name);J3D.Loader.loadGLSL(m.path,p);
break;case "json":p=function(a){return function(b){d.assets[a]=b;j(i)}}(m.name);J3D.Loader.loadJSON(m.path,p);break;case "image":var r=new Image;d.assets[m.name]=r;p=function(){j(i)};r.onload=p;r.src=m.path;break;default:p=function(a){return function(b){d.assets[a]=b;j(i)}}(m.name),J3D.Loader.loadPlainText(m.path,p)}}}};J3D.BuiltinShaders=function(){var a={},b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Phong);b.color=J3D.Color.white;b.emissive=J3D.Color.black;b.hasColorTexture=!1;a.Phong=b;b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Gouraud);b.color=J3D.Color.black;b.emissive=J3D.Color.black;b.specularIntensity=0;b.shininess=0;a.Gouraud=b;b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Lightmap);b.setup=function(a,b){for(var h in a.uniforms)h=="lightmapTexture"?J3D.ShaderUtil.setTexture(a,1,"lightmapTexture",J3D.LightmapAtlas[b.lightmapIndex]):
h=="lightmapAtlas"&&gl.uniform4fv(a.uniforms.lightmapAtlas.location,b.lightmapTileOffset);J3D.Shader.prototype.setup.call(this,a,b)};a.Lightmap=b;a.Skybox=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Skybox);a.Background=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Background);a.Vignette=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Vignette);a.Normal2Color=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Normal2Color);b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Selflit);b.color=J3D.Color.white;a.Selflit=b;return{shaders:a,
fetch:function(b){if(a[b])return a[b].clone();else throw J3D.Error.NO_BUILTIN_SHADER+b;},replace:function(b,e){a[b]=e}}};J3D.PERSPECTIVE=0;J3D.ORTHO=1;
J3D.Camera=function(a){that=this;a||(a={});if(!a.type)a.type=J3D.PERSPECTIVE;if(!a.near)a.near=1;if(!a.far)a.far=1E3;if(a.type==J3D.PERSPECTIVE){if(!a.fov)a.fov=45}else{if(a.left==null)a.left=0;if(a.right==null)a.right=1;if(a.top==null)a.top=0;if(a.bottom==null)a.bottom=1}this.near=a.near;this.far=a.far;this.fov=a.fov;this.onResize=function(){this.projectionMat=new m44;a.type==J3D.PERSPECTIVE?(this.aspect=gl.viewportWidth/gl.viewportHeight,this.projectionMat.perspective(a.fov,this.aspect,a.near,a.far)):
this.projectionMat.ortho(a.left,a.right,a.top,a.bottom,a.near,a.far)};this.onResize()};J3D.Collider=function(){this.center=v3.ZERO()};J3D.Collider.SPHERE=1;J3D.Collider.BOX=2;J3D.Collider.MESH=3;J3D.Collider.Sphere=function(a,b){var d=new J3D.Collider;d.type=J3D.Collider.SPHERE;d.radius=a||0;d.center=b||v3.ZERO();return d};J3D.Collider.Box=function(a){var b=new J3D.Collider;b.type=J3D.Collider.BOX;b.box=a;return b};J3D.Collider.Mesh=function(a){var b=new J3D.Collider;b.type=J3D.Collider.MESH;a.boundingBox||a.calculateBoundingBox();b.box=a.boundingBox;b.mesh=a;return b};J3D.Cubemap=function(a,b){var d=this;this.tex=gl.createTexture();var e=6,h={};b||(b={});var g=function(){e--;if(e<=0&&(gl.bindTexture(gl.TEXTURE_CUBE_MAP,d.tex),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,h.front),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,h.back),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,h.up),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,
h.down),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,h.right),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,h.left),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.generateMipmap(gl.TEXTURE_CUBE_MAP),
gl.bindTexture(gl.TEXTURE_CUBE_MAP,null),b.onLoad))b.onLoad()},i=function(a,b){typeof b=="string"?(h[a]=new Image,h[a].onload=g,h[a].src=b):b.getContext&&(h[a]=b,g())};a.left?(i("left",a.left),i("right",a.right),i("up",a.up),i("down",a.down),i("back",a.back),i("front",a.front)):(i("left",a),i("right",a),i("up",a),i("down",a),i("back",a),i("front",a))};var gl;
J3D.Engine=function(a,b,d){var e=this;b=b||{};d=d||{};var h=a?a:document.createElement("canvas"),g=!0;this.resolution=b&&b.resolution?b.resolution:1;a||(g=!1,b.container?b.container.appendChild(h):document.body.appendChild(h));try{gl=h.getContext("experimental-webgl",d)}catch(i){throw J3D.Error.NO_WEBGL_CONTEXT;}if(typeof J3D.BuiltinShaders=="function")J3D.BuiltinShaders=J3D.BuiltinShaders();this.shaderAtlas=new J3D.ShaderAtlas;this.scene=new J3D.Scene;this.outCanvas=h;this.gl=gl;this.setClearColor=function(a){if(!d||
!d.alpha)this.outCanvas.style["background-color"]=a.toRGB();gl.clearColor(a.r,a.g,a.b,a.a)};this.clear=function(){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CW);this.setClearColor(J3D.Color.black);this._opaqueMeshes=[];this._transparentMeshes=[];this._lights=[];this.scene.removeAll();this.shaderAtlas.clear()};this.destroy=function(){gl=null;g||(window.removeEventListener("resize",k),document.body.removeChild(h))};this.resize=function(a,b){if(gl&&gl!=void 0){var d=a?a:window.innerWidth,e=b?b:window.innerHeight;
h.width=d/this.resolution;h.height=e/this.resolution;h.style.width=d+"px";h.style.height=e+"px";gl.viewportWidth=h.width;gl.viewportHeight=h.height;gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);if(this.scene.camera)this.scene.camera.camera.onResize()}};var k=function(){e.resize()};g?this.resize(a.width,a.height):(this.resize(),window.addEventListener("resize",k));this.clear()};
J3D.Engine.prototype.render=function(a){J3D.Time.tick();a||gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);if(!this.scene.camera)throw J3D.Error.NO_CAMERA;(this.scene.numChildren>0||this.scene.background)&&this.renderScene()};
J3D.Engine.prototype.renderScene=function(){var a,b;this._opaqueMeshes.length=0;this._transparentMeshes.length=0;for(a=this._lights.length=0;a<this.scene.numChildren;a++)this.updateTransform(this.scene.childAt(a),null);this.scene.camera.updateInverseMat();if(this.scene.skybox)gl.depthMask(!1),a=this.scene.camera.camera,b=this.scene.skybox,b.renderer.mid=a.near+(a.far-a.near)/2,this.renderObject(b),gl.depthMask(!0);this.scene.background&&(gl.depthMask(!1),this.renderObject(this.scene.background),gl.depthMask(!0));
gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);b=this._opaqueMeshes.length;for(a=0;a<b;a++)this.renderObject(this._opaqueMeshes[a]);gl.enable(gl.BLEND);b=this._transparentMeshes.length;for(a=0;a<b;a++){var d=this._transparentMeshes[a],e=d.geometry.srcFactor!=null?d.geometry.srcFactor:gl.SRC_ALPHA,h=d.geometry.dstFactor!=null?d.geometry.dstFactor:gl.ONE;d.disableDepthTest?gl.disable(gl.DEPTH_TEST):gl.enable(gl.DEPTH_TEST);gl.blendFunc(e,h);this.renderObject(d)}gl.flush()};
J3D.Engine.prototype.renderObject=function(a){var b=this.shaderAtlas.getShader(a.renderer),d=this.scene.camera;J3D.Performance.programChaged++;gl.useProgram(b);b.uniforms.pMatrix&&gl.uniformMatrix4fv(b.uniforms.pMatrix.location,!1,d.camera.projectionMat.toArray());b.uniforms.vMatrix&&gl.uniformMatrix4fv(b.uniforms.vMatrix.location,!1,d.inverseMat);b.uniforms.mMatrix&&gl.uniformMatrix4fv(b.uniforms.mMatrix.location,!1,a.globalMatrix);b.uniforms.nMatrix&&gl.uniformMatrix3fv(b.uniforms.nMatrix.location,
!1,a.normalMatrix);b.uniforms.uEyePosition&&gl.uniform3fv(b.uniforms.uEyePosition.location,d.worldPosition);b.uniforms.uTileOffset&&gl.uniform4fv(b.uniforms.uTileOffset.location,a.getTileOffset());this._lights.length>0&&J3D.ShaderUtil.setLights(b,this._lights);J3D.ShaderUtil.setAttributes(b,a.geometry);a.renderer.setup(b,a);gl.cullFace(a.renderer.cullFace||gl.BACK);b=a.renderer.drawMode!=null?a.renderer.drawMode:gl.TRIANGLES;a.geometry.hasElements?(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,a.geometry.elements.buffer),
gl.drawElements(b,a.geometry.elements.size,gl.UNSIGNED_SHORT,0)):gl.drawArrays(b,0,a.geometry.size)};J3D.Engine.prototype.updateTransform=function(a,b){J3D.Performance.numTransforms++;a.animation&&a.animation.animateTransform(a);a.updateWorld(b);for(var d=0;d<a.numChildren;d++)this.updateTransform(a.childAt(d),a);a.enabled&&(a.renderer&&a.geometry&&(a.geometry.renderMode==J3D.RENDER_AS_TRANSPARENT?this._transparentMeshes.push(a):this._opaqueMeshes.push(a)),a.light&&this._lights.push(a))};J3D.FrameBuffer=function(a,b){var d=this;this.width=a?a:gl.viewportWidth;this.height=b?b:gl.viewportHeight;this.fbo=gl.createFramebuffer();this.texture=gl.createTexture();this.depthBuffer=gl.createRenderbuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo);gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthBuffer);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,
null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);this.resize=function(a,b){this.width=a?a:gl.viewportWidth;this.height=b?b:gl.viewportHeight;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null)};var e;a||window.addEventListener("resize",
function(){d.resize()})};J3D.FrameBuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo)};J3D.FrameBuffer.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null)};J3D.Geometry=function(){this.renderMode=J3D.RENDER_AS_OPAQUE;this.arrays=[];this.arraysByName={};this.elements=null;this.hasElements=!1;this.size=0};J3D.Geometry.prototype.setTransparency=function(a,b,d){a?(this.renderMode=J3D.RENDER_AS_TRANSPARENT,this.srcFactor=b,this.dstFactor=d):this.renderMode=J3D.RENDER_AS_OPAQUE};
J3D.Geometry.prototype.addArray=function(a,b,d,e,h){if(!e)e=gl.FLOAT;if(!h)h=gl.STATIC_DRAW;b=new J3D.Geometry.Attribute(a,b,d,e,h,gl.ARRAY_BUFFER);this.arrays.push(b);this.arraysByName[a]=b;this.size=b.size;return b};J3D.Geometry.prototype.replaceArray=function(a,b){a.data=b;gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer);gl.bufferData(gl.ARRAY_BUFFER,b,a.usage)};
J3D.Geometry.prototype.addElement=function(a,b,d){if(!b)b=gl.UNSIGNED_SHORT;if(!d)d=gl.STATIC_DRAW;this.elements=new J3D.Geometry.Attribute("",a,0,b,d,gl.ELEMENT_ARRAY_BUFFER);this.hasElements=!0};J3D.Geometry.Attribute=function(a,b,d,e,h,g){this.name=a;this.data=b;this.usage=h;this.buffer=gl.createBuffer();gl.bindBuffer(g,this.buffer);gl.bufferData(g,b,h);this.size=d>0?b.length/d:b.length;this.itemSize=d;this.type=e};J3D.Light=function(a){this.type=a!=null?a:J3D.NONE;this.color=J3D.Color.white;this.intensity=1;this.angle=this.angleFalloff=0};J3D.NONE=-1;J3D.AMBIENT=0;J3D.DIRECT=1;J3D.POINT=2;J3D.SPOTLIGHT=3;J3D.HEMISPHERE=4;J3D.SPHERICAL_HARMONICS=5;J3D.Loader={};J3D.Loader.loadJSON=function(a,b){var d=new XMLHttpRequest;d.open("GET",a);d.onreadystatechange=function(){d.readyState==4&&b.call(null,JSON.parse(d.responseText))};d.send()};J3D.Loader.loadPlainText=function(a,b){var d=new XMLHttpRequest;d.open("GET",a);d.onreadystatechange=function(){d.readyState==4&&b.call(null,d.responseText)};d.send()};
J3D.Loader.parseJSONScene=function(a,b,d,e){var h=new J3D.Transform;h.light=new J3D.Light(J3D.AMBIENT);h.light.color=J3D.Loader.fromObject(J3D.Color,b.ambient);a.scene.add(h);for(var g in d)d[g]=new J3D.Mesh(d[g]);if(e)for(g in e)e[g]=new J3D.Animation(e[g]);a.setClearColor(J3D.Loader.fromObject(J3D.Color,b.background));for(var i in b.textures)h=new J3D.Texture(b.path+b.textures[i].file),b.textures[i]=h;if(b.lightmaps){J3D.LightmapAtlas=[];for(g=0;g<b.lightmaps.length;g++)h=new J3D.Texture(b.path+
b.lightmaps[g]),J3D.LightmapAtlas.push(h)}for(var k in b.materials){g=b.materials[k];g=J3D.Loader.fetchShader(g.type,g);g.color=J3D.Loader.fromObject(J3D.Color,g.color);if(g.emissive)g.emissive=J3D.Loader.fromObject(J3D.Color,g.emissive);if(g.textureTile)g.textureTile=J3D.Loader.v2FromArray(g.textureTile);if(g.textureOffset)g.textureOffset=J3D.Loader.v2FromArray(g.textureOffset);if(g.colorTexture)g.colorTexture=b.textures[g.colorTexture],g.hasColorTexture=!0;b.materials[k]=g}for(var j in b.lights)g=
b.lights[j],g=J3D.Loader.fromObject(J3D.Light,g),g.color=J3D.Loader.fromObject(J3D.Color,g.color),b.lights[j]=g;for(var l in b.cameras)g=b.cameras[l],g=new J3D.Camera({fov:g.fov,near:g.near,far:g.far}),b.cameras[l]=g;j=function(a){var b=a.collider;switch(b.type){case "box":var e=J3D.Loader.v3FromArray(b.size),h=J3D.Loader.v3FromArray(b.center);a.collider=J3D.Collider.Box({minX:h.x+e.x*-0.5,maxX:h.x+e.x*0.5,minY:h.y+e.y*-0.5,maxY:h.y+e.y*0.5,minZ:h.z+e.z*-0.5,maxZ:h.z+e.z*0.5});break;case "sphere":h=
J3D.Loader.v3FromArray(b.center);a.collider=J3D.Collider.Sphere(b.radius,h);break;case "mesh":a.collider=J3D.Collider.Mesh(d[b.mesh])}};for(g=0;g<b.transforms.length;g++){l=b.transforms[g];l=J3D.Loader.fromObject(J3D.Transform,l);l.position=J3D.Loader.v3FromArray(l.position);b.quaternions?(l.useQuaternion=!0,l.rotationq=J3D.Loader.quatFromArray(l.rotation),l.rotation=new v3):(l.useQuaternion=!1,l.rotation=J3D.Loader.v3FromArray(l.rotation));if(l.scale instanceof Array)l.scale=J3D.Loader.v3FromArray(l.scale);
if(l.renderer)l.renderer=b.materials[l.renderer];if(l.mesh)l.geometry=d[l.mesh];if(l.animation)l.animation=e[l.animation];if(l.light)l.light=b.lights[l.light];l.collider&&j(l);if(l.camera)l.camera=b.cameras[l.camera],a.scene.setCamera(l);b.transforms[g]=l}e=function(a){for(var d=0;d<b.transforms.length;d++)if(b.transforms[d].uid==a)return b.transforms[d]};for(g=0;g<b.transforms.length;g++)l=b.transforms[g],l.parent!=null?(l.parent=e(l.parent),l.parent.add(l)):a.scene.add(l)};
J3D.Loader.fetchShader=function(a,b){var d=J3D.BuiltinShaders.fetch(a),e;for(e in b)d[e]=b[e];return d};J3D.Loader.fromObject=function(a,b){var d=new a,e;for(e in b)d[e]=b[e];return d};J3D.Loader.v2FromArray=function(a){return new v2(a[0],a[1])};J3D.Loader.v3FromArray=function(a){return new v3(a[0],a[1],a[2])};J3D.Loader.quatFromArray=function(a){return quat4.normalize(quat4.createFrom(a[0],a[1],a[2],a[3]))};
J3D.Loader.loadGLSL=function(a,b){var d=new XMLHttpRequest;d.open("GET",a+"?"+Math.random());d.onreadystatechange=function(){d.readyState==4&&b.call(null,J3D.ShaderUtil.parseGLSL(d.responseText))};d.send()};J3D.Mesh=function(a){that=this;J3D.Geometry.call(this);this.hasUV1=!1;this.calculateBoundingBox=function(){for(var b=a.vertices,e={minX:Number.MAX_VALUE,maxX:-Number.MIN_VALUE,minY:Number.MAX_VALUE,maxY:-Number.MIN_VALUE,minZ:Number.MAX_VALUE,maxZ:-Number.MIN_VALUE},h=0;h<b.length;h+=3)e.minX=Math.min(e.minX,b[h+0]),e.maxX=Math.max(e.maxX,b[h+0]),e.minY=Math.min(e.minY,b[h+1]),e.maxY=Math.max(e.maxY,b[h+1]),e.minZ=Math.min(e.minZ,b[h+2]),e.maxZ=Math.max(e.maxZ,b[h+2]);this.boundingBox=e};for(var b in a)switch(b){case "vertices":this.vertexPositionBuffer=
this.addArray(J3D.Mesh.VERTEX_POSITION,new Float32Array(a[b]),3,gl.DYNAMIC_DRAW);break;case "colors":a[b].length>0&&this.addArray("aVertexColor",new Float32Array(a[b]),4);break;case "normals":this.vertexNormalBuffer=a[b].length>0?this.addArray("aVertexNormal",new Float32Array(a[b]),3):this.addArray("aVertexNormal",new Float32Array(this.size*3),3);break;case "uv1":this.textureCoordBuffer=a[b].length>0?this.addArray("aTextureCoord",new Float32Array(a[b]),2):this.addArray("aTextureCoord",new Float32Array(this.size*
2),2);this.hasUV1=!0;break;case "uv2":a[b].length>0&&this.addArray("aTextureCoord2",new Float32Array(a[b]),2);break;case "tris":a[b].length>0&&this.addElement(new Uint16Array(a[b]));break;case "tangents":a[b].length>0&&this.addArray("aVertexTangent",new Float32Array(a[b]),4);break;default:console.warn("WARNING! Unknown attribute in geometry: "+b+". It will be ignored.")}this.flip=function(){var a=[],b=[],h=this.vertexPositionBuffer.data,g=this.vertexNormalBuffer.data,i;for(i=0;i<h.length;i+=3)a.push(h[i],
h[i+2],h[i+1]),b.push(g[i],g[i+1],g[i+2]);this.replaceArray(this.vertexPositionBuffer,new Float32Array(a));this.replaceArray(this.vertexNormalBuffer,new Float32Array(b));return this}};J3D.Mesh.prototype=new J3D.Geometry;J3D.Mesh.prototype.constructor=J3D.Mesh;J3D.Mesh.prototype.supr=J3D.Geometry.prototype;J3D.Mesh.VERTEX_POSITION="aVertexPosition";J3D.Postprocess=function(a){this.drawMode=gl.TRIANGLES;this.engine=a;this.fbo=new J3D.FrameBuffer;this.geometry=J3D.Primitive.FullScreenQuad();this.filter=null};J3D.Postprocess.prototype.render=function(){this.fbo.bind();this.engine.render();this.fbo.unbind();this.renderEffect(this.fbo.texture)};
J3D.Postprocess.prototype.renderEffect=function(a){this.program=this.engine.shaderAtlas.getShader(this.filter);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.program);J3D.ShaderUtil.setAttributes(this.program,this.geometry);this.filter.uTexture=a;this.filter.setup(this.program);this.geometry.renderMode==J3D.RENDER_AS_OPAQUE?(gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST)):(gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(this.geometry.srcFactor!=null?this.geometry.srcFactor:
gl.SRC_ALPHA,this.geometry.dstFactor!=null?this.geometry.dstFactor:gl.ONE));gl.drawArrays(this.drawMode,0,this.geometry.size)};J3D.Primitive={};
J3D.Primitive.Cube=function(a,b,d,e){var h=J3D.Primitive.getEmpty();a*=0.5;b*=0.5;d*=0.5;var g=[0,1,0,1],i=[];i[0]=e?[0,0.5,0,1/3]:g;i[1]=e?[0.5,1,0,1/3]:g;i[2]=e?[0,0.5,1/3,2/3]:g;i[3]=e?[0.5,1,1/3,2/3]:g;i[4]=e?[0,0.5,2/3,1]:g;i[5]=e?[0.5,1,2/3,1]:g;J3D.Primitive.addQuad(h,new v3(-a,b,d),new v3(a,b,d),new v3(a,-b,d),new v3(-a,-b,d),i[0]);J3D.Primitive.addQuad(h,new v3(a,b,-d),new v3(-a,b,-d),new v3(-a,-b,-d),new v3(a,-b,-d),i[1]);J3D.Primitive.addQuad(h,new v3(-a,b,-d),new v3(-a,b,d),new v3(-a,
-b,d),new v3(-a,-b,-d),i[2]);J3D.Primitive.addQuad(h,new v3(a,b,d),new v3(a,b,-d),new v3(a,-b,-d),new v3(a,-b,d),i[3]);J3D.Primitive.addQuad(h,new v3(a,b,d),new v3(-a,b,d),new v3(-a,b,-d),new v3(a,b,-d),i[4]);J3D.Primitive.addQuad(h,new v3(a,-b,d),new v3(a,-b,-d),new v3(-a,-b,-d),new v3(-a,-b,d),i[5]);return new J3D.Mesh(h)};
J3D.Primitive.FullScreenQuad=function(){var a=new J3D.Geometry;a.addArray("aVertexPosition",new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),2);a.addArray("aTextureCoord",new Float32Array([0,1,1,1,1,0,0,1,1,0,0,0]),2);return a};
J3D.Primitive.Plane=function(a,b,d,e,h,g,i){var k=J3D.Primitive.getEmpty();h||(h=0);g||(g=0);a*=0.5;b*=0.5;d||(d=1);e||(e=1);h=-a+h;g=b+g;var j=i&&i.us?i.us:0,l=i&&i.ue?i.ue:1,m=i&&i.vs?i.vs:0;i=i&&i.ve?i.ve:1;a=a*2/d;b=b*2/e;for(var p=0;p<d;p++)for(var r=0;r<e;r++){var o=h+p*a,n=o+a,u=g-r*b,q=u-b,t;t=new v3(o,u,0);u=new v3(n,u,0);n=new v3(n,q,0);o=new v3(o,q,0);J3D.Primitive.addQuad(k,t,u,n,o,[j+1/d*p*(l-j),j+1/d*(p+1)*(l-j),1-(m+1/e*(r+1)*(i-m)),1-(m+1/e*r*(i-m))])}return new J3D.Mesh(k)};
J3D.Primitive.Sphere=function(a,b,d){var e=J3D.Primitive.getEmpty(),h=[],g=[];a=a||50;b=Math.max(3,Math.floor(b)||8);d=Math.max(3,Math.floor(d)||6);var i=Math.PI*2,k=Math.PI,j,l;for(l=0;l<=d;l++)for(j=0;j<=b;j++){var m=j/b,p=l/d;h.push(new v3(-a*Math.cos(0+m*i)*Math.sin(0+p*k),a*Math.cos(0+p*k),a*Math.sin(0+m*i)*Math.sin(0+p*k)));g.push([m,1-p])}for(l=0;l<d;l++)for(j=0;j<b;j++){var r=b+1;a=h[l*r+j+0];i=h[l*r+j+1];k=h[(l+1)*r+j+1];m=h[(l+1)*r+j+0];p=g[l*r+j+0];var o=g[l*r+j+1],n=g[(l+1)*r+j+1];r=g[(l+
1)*r+j+0];var u=a.cp().norm(),q=i.cp().norm(),t=k.cp().norm(),v=m.cp().norm(),c=Math.floor(e.vertices.length/3);e.vertices.push(a.x,a.y,a.z,i.x,i.y,i.z,k.x,k.y,k.z,m.x,m.y,m.z);e.uv1.push(p[0],p[1],o[0],o[1],n[0],n[1],r[0],r[1]);e.normals.push(u.x,u.y,u.z,q.x,q.y,q.z,t.x,t.y,t.z,v.x,v.y,v.z);e.tris.push(c+0,c+1,c+2,c+0,c+2,c+3)}J3D.MathUtil.calculateTangents(e);return new J3D.Mesh(e)};
J3D.Primitive.SingleTextureSkybox=function(a,b){var d=J3D.Primitive.getEmpty(),e=[],h=[],g=g||50,i=Math.max(3,Math.floor(a)||8),k=Math.max(3,Math.floor(b)||6),j=Math.PI*2,l=Math.PI,m,p;for(p=0;p<=k;p++)for(m=0;m<=i;m++){var r=m/i,o=p/k,n=new v3(Math.cos(0+r*j)*Math.sin(0+o*l)*-1,Math.cos(0+o*l),Math.sin(0+r*j)*Math.sin(0+o*l)),u=Math.max(Math.max(n.x,n.y),n.z),q=Math.min(Math.min(n.x,n.y),n.z);Math.abs(q)>u?(u=q,q=-g):q=g;if(u==n.x)u=q/n.x,n.x=n.x*q/n.x,n.y*=u,n.z*=u;else if(u==n.y)u=q/n.y,n.y=q,
n.x*=u,n.z*=u;else if(u==n.z)u=q/n.z,n.z=q,n.x*=u,n.y*=u;e.push(n);h.push([r,o])}for(p=0;p<=k;p++)for(m=0;m<i;m++){g=e[p*i+m+0];j=e[p*i+m+1];l=e[(p+1)*i+m+1];r=e[(p+1)*i+m+0];o=h[p*i+m+0];n=h[p*i+m+1];u=h[(p+1)*i+m+1];q=h[(p+1)*i+m+0];var t=d.vertices.length/3;d.vertices.push(g.x,g.y,g.z,j.x,j.y,j.z,l.x,l.y,l.z,r.x,r.y,r.z);d.uv1.push(o[0],o[1],n[0],n[1],u[0],u[1],q[0],q[1]);d.tris.push(t+0,t+2,t+1,t+0,t+3,t+2)}return new J3D.Mesh(d)};
J3D.Primitive.getEmpty=function(){var a={};a.vertices=[];a.normals=[];a.uv1=[];a.tangents=[];a.tris=[];return a};
J3D.Primitive.addQuad=function(a,b,d,e,h,g,i){if(!J3D.Primitive.__tv1)J3D.Primitive.__tv1=new v3;var k=J3D.Primitive.__tv1;v3.calculateNormal(b,d,e,k).norm();var j=a.vertices.length/3;if(!g||!g.length||g.length!=4)g=[0,1,0,1];a.vertices.push(b.x,b.y,b.z,d.x,d.y,d.z,e.x,e.y,e.z,h.x,h.y,h.z);a.normals.push(k.x,k.y,k.z,k.x,k.y,k.z,k.x,k.y,k.z,k.x,k.y,k.z);i?a.uv1.push(g[0],g[3],g[0],g[2],g[1],g[2],g[1],g[3]):a.uv1.push(g[0],g[3],g[1],g[3],g[1],g[2],g[0],g[2]);a.tris.push(j,j+1,j+2,j,j+2,j+3)};J3D.Ray=function(a,b){this.origin=a||new v3;this.direction=b||new v3;this.localOrigin=new v3;this.localDirection=new v3};J3D.Ray._mt=mat4.create();J3D.Ray._nt=mat3.create();
J3D.Ray.fromMousePosition=function(a,b,d,e,h){if(!J3D.Ray._wp)J3D.Ray._wp=new v3;e||(e={x:0,y:0,width:window.innerWidth,height:window.innerHeight});a=[(a-e.x)/e.width*2-1,(1-(b-e.y)/e.height)*2-1,0];mat4.inverse(d.camera.projectionMat.toArray(),J3D.Ray._mt);mat4.multiplyVec3(J3D.Ray._mt,a);mat4.multiplyVec3(d.globalMatrix,a);h=h||new J3D.Ray;h.origin.fromArray(a);J3D.Ray._wp.fromArray(d.worldPosition);v3.sub(h.origin,J3D.Ray._wp,h.direction).norm();return h};
J3D.Ray.prototype.makeLocal=function(a){mat4.inverse(a.globalMatrix,J3D.Ray._mt);this.localOrigin.fromArray(mat4.multiplyVec3(J3D.Ray._mt,this.origin.xyz()));mat4.toInverseMat3(a.globalMatrix,J3D.Ray._nt);mat3.transpose(J3D.Ray._nt);a=this.direction;var b=this.direction.xyz(),d=J3D.Ray._nt;b[0]=a.x*d[0]+a.y*d[1]+a.z*d[2];b[1]=a.x*d[3]+a.y*d[4]+a.z*d[5];b[2]=a.x*d[6]+a.y*d[7]+a.z*d[8];this.localDirection.fromArray(b)};J3D.Scene=function(){var a=[];this.numChildren=0;this.add=function(){for(var b,d=0;d<arguments.length;d++){var e=arguments[d];b||(b=e);a.indexOf(e)==-1&&a.push(e);e.parent=null;this.numChildren=a.length}return b};this.recurse=function(b){for(var d=0;d<a.length;d++)a[d].recurse(b)};this.childAt=function(b){return a[b]};this.contains=function(b){return a.indexOf(b)>-1};this.remove=function(b,d){if(this.contains(b))return a.splice(a.indexOf(b),1),this.numChildren=a.length,!0;else if(d)for(var e=0;e<
a.length;e++){if(a[e].remove(b))return!0}else return!1};this.removeAll=function(){a=[];this.numChildren=0;this.background=this.skybox=this.camera=null};this.addSkybox=function(a,d){if(!a)throw"Scene.addSkybox: missing cubemap argument";if(!this.skybox)this.skybox=new J3D.Transform,this.skybox.geometry=J3D.Primitive.Cube(1,1,1).flip();this.skybox.renderer=d||J3D.BuiltinShaders.fetch("Skybox");this.skybox.renderer.uTexture=a};this.addBackground=function(a,d){if(!this.background&&(this.background=new J3D.Transform,
this.background.geometry=J3D.Primitive.FullScreenQuad(),!d))this.background.renderer=J3D.BuiltinShaders.fetch("Background");if(d)this.background.renderer=d;if(a)this.background.renderer.uTexture=a};this.setCamera=function(a){this.camera=a};this.find=function(a){a=a.split("/");for(var d=0;d<this.numChildren;d++)if(this.childAt(d).name==a[0])return a.length==1?this.childAt(d):this.childAt(d).find(a.slice(1).join("/"));return null};this.listChildren=function(){for(var b=0;b<this.numChildren;b++)console.log(a[b].name)}};J3D.Shader=function(a,b,d,e){if(!a)throw Error("You must specify a name for custom shaders");if(b==null||d==null)throw Error("You must pass a vertex and fragment shader source for custom shaders");this.name=a;this.drawMode=4;this._vertSource=b;this._fragSource=d;this.reloadStaticUniforms=!0;this.su={};this.loadedStaticTextures={};this.metaData=e||{};this.cloneCount=0};J3D.Shader.prototype.vertSource=function(){return this._vertSource};J3D.Shader.prototype.fragSource=function(){return this._fragSource};
J3D.Shader.prototype.setup=function(a){if(this.reloadStaticUniforms)this.loadedStaticTextures={};this.uTime=J3D.Time.time;var b=0,d;for(d in a.uniforms)this.reloadStaticUniforms&&this.su[d]!=null&&this[d]==null&&this.su[d].loaded==null&&J3D.ShaderUtil.setUniform(d,a,this.su),this.su[d]!=null&&this[d]==null&&this.su[d].loaded&&!this.loadedStaticTextures[d]&&(J3D.ShaderUtil.setUniform(d,a,this.su),this.loadedStaticTextures[d]=!0),this[d]!=null&&(b++,J3D.ShaderUtil.setUniform(d,a,this));this.reloadStaticUniforms=
!1};J3D.Shader.prototype.clone=function(){this.cloneCount++;var a=new J3D.Shader(this.name,this._vertSource,this._fragSource);for(s in this)typeof this[s]!=="function"&&this.hasOwnProperty(s)&&s!="name"&&(a[s]=this[s]);if(this.hasOwnProperty("setup"))a.setup=this.setup;a.su={};for(ss in this.su)typeof this.su[ss]!=="function"&&this.su.hasOwnProperty(ss)&&(a.su[ss]=this.su[ss]);a.reloadStaticUniforms=!0;return a};J3D.ShaderAtlas=function(){this.clear()};
J3D.ShaderAtlas.prototype.compileShaderSource=function(a,b,d,e){var h="";if(e.includes&&e.includes.length>0)for(var g=0;g<e.includes.length;g++)h+=J3D.ShaderSource[e.includes[g]];h+=e.common||"";if(d==gl.VERTEX_SHADER){var i="";if(e.vertexIncludes&&e.vertexIncludes.length>0)for(g=0;g<e.vertexIncludes.length;g++)i+=J3D.ShaderSource[e.vertexIncludes[g]]}else if(i="",e.fragmentIncludes&&e.fragmentIncludes.length>0)for(g=0;g<e.fragmentIncludes.length;g++)i+=J3D.ShaderSource[e.fragmentIncludes[g]];b=h+
i+b;console.log("#### #### #### #### #### "+a);console.log(b);d=gl.createShader(d);gl.shaderSource(d,b);gl.compileShader(d);if(!gl.getShaderParameter(d,gl.COMPILE_STATUS))throw J3D.Error.SHADER_COMPILE_ERROR+gl.getShaderInfoLog(d);this.programs[a]=d};
J3D.ShaderAtlas.prototype.linkShader=function(a){a=a.name;var b=this.programs[a+"Vert"],d=this.programs[a+"Frag"],e=gl.createProgram();gl.attachShader(e,b);gl.attachShader(e,d);gl.linkProgram(e);if(!gl.getProgramParameter(e,gl.LINK_STATUS))throw J3D.Error.SHADER_LINK_ERROR+gl.getProgramInfoLog(e);gl.useProgram(e);d=0;e.uniforms={};var h=gl.getProgramParameter(e,gl.ACTIVE_UNIFORMS);for(b=0;b<h;b++){var g=gl.getActiveUniform(e,b);e.uniforms[g.name]=g;e.uniforms[g.name].location=gl.getUniformLocation(e,
g.name);if(J3D.ShaderUtil.isTexture(g.type))e.uniforms[g.name].texid=d,d++}e.attributes={};d=gl.getProgramParameter(e,gl.ACTIVE_ATTRIBUTES);for(b=0;b<d;b++)h=gl.getActiveAttrib(e,b),e.attributes[h.name]=gl.getAttribLocation(e,h.name),gl.enableVertexAttribArray(e.attributes[h.name]);this.shaderCount++;this.shaders[a]=e};
J3D.ShaderAtlas.prototype.getShader=function(a){this.shaders[a.name]||(this.compileShaderSource(a.name+"Vert",a.vertSource(),gl.VERTEX_SHADER,a.metaData),this.compileShaderSource(a.name+"Frag",a.fragSource(),gl.FRAGMENT_SHADER,a.metaData),this.linkShader(a));return this.shaders[a.name]};J3D.ShaderAtlas.prototype.clear=function(){this.shaders={};this.programs={};this.shaderCount=0};J3D.ShaderSource={};J3D.ShaderSource.Background="//#name Background\n//#author bartekd\n//#include CommonFilterInclude\n//#vertex\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = vec4(aVertexPosition, 0.0, 1.0);\nvTextureCoord = aTextureCoord;\n}\n//#fragment\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_FragColor = texture2D(uTexture, vTextureCoord);\n}\n";
J3D.ShaderSource.CopyFilter="//#name CopyFilter\n//#description All this shader does is to render a texture (typically a render texture) pixel-to-pixel.\n//#description It is useful in effects like Persistence\n//#author bartekd\n//#include CommonFilterInclude\n//#vertex\n//#include BasicFilterVertex\n//#fragment\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = texture2D(uTexture, vTextureCoord);\ngl_FragColor = vec4(p.rgb, 1.0);\n}\n";
J3D.ShaderSource.Depth="//#name Depth\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying float depth;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\ndepth = gl_Position.z/gl_Position.w;\n}\n//#fragment\nvarying float depth;\nvoid main(void) {\nfloat d = 1.0 - depth;\ngl_FragColor = vec4(d, d, d, 1.0);\n}\n";J3D.ShaderSource.Gouraud="//#name Gouraud\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\n//#include Lights\nuniform float specularIntensity;\nuniform float shininess;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\nvTextureCoord = getTextureCoord(aTextureCoord);\nvec3 n = nMatrix * aVertexNormal;\nvLight = computeLights(p, n, specularIntensity, shininess);\n}\n//#fragment\nuniform vec4 color;\nuniform vec3 emissive;\nuniform sampler2D colorTexture;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = texture2D(colorTexture, vTextureCoord);\nvec3 fc = (color.rgb + tc.rgb) * vLight + emissive.rgb;\ngl_FragColor = vec4(fc, clamp(tc.a, 0.0, 1.0));\n}\n";
J3D.ShaderSource.Lightmap="//#name Lightmap\n//#author bartekd\n//#include CommonInclude\nvarying vec2 vTextureCoord;\nvarying vec2 vTextureCoord2;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\n//#vertex\n//#include VertexInclude\nuniform vec4 lightmapAtlas;\nvoid main(void) {\nvTextureCoord = getTextureCoord(aTextureCoord);\nvTextureCoord2 = aTextureCoord2 * lightmapAtlas.xy + lightmapAtlas.zw;\nvNormal = nMatrix * aVertexNormal;\nvPosition = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * vPosition;\ngl_PointSize = 5.0;\n}\n//#fragment\n//#include Lights\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform sampler2D lightmapTexture;\nuniform float specularIntensity;\nuniform float shininess;\nvoid main(void) {\nvec4 tc = texture2D(colorTexture, vTextureCoord);\nvec4 lm = texture2D(lightmapTexture, vTextureCoord2);\nfloat si = specularIntensity * tc.r;\nvec3 ltc = computeLights(vPosition, vNormal, si, shininess);\nvec3 lmc = lm.rgb * lm.a;\nif(tc.a < 0.1) discard;\nelse gl_FragColor = vec4(color.rgb * tc.rgb * (ltc + lmc), 1.0);\n}\n";
J3D.ShaderSource.Normal2Color="//#name Normal2Color\n//#description Simplest shader possible, no includes\n//#author bartekd\nprecision mediump float;\nvarying vec3 vColor;\n//#vertex\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nuniform mat4 mMatrix;\nuniform mat4 vMatrix;\nuniform mat4 pMatrix;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * mMatrix * vec4(aVertexPosition, 1.0);\nvColor = normalize( aVertexNormal / 2.0 + vec3(0.5) );\n}\n//#fragment\nvoid main(void) {\ngl_FragColor = vec4(vColor, 1.0);\n}\n";
J3D.ShaderSource.Phong="//#name Phong\n//#description Classic phong shader\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec4 vPosition;\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal;\nvoid main(void) {\nvTextureCoord = getTextureCoord(aTextureCoord);\nvNormal = nMatrix * aVertexNormal;\nvPosition = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * vPosition;\ngl_PointSize = 5.0;\n}\n//#fragment\n//#include Lights\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nuniform float specularIntensity;\nuniform float shininess;\nvarying vec4 vPosition;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\nvec3 l = computeLights(vPosition, vNormal, specularIntensity, shininess);\ngl_FragColor = vec4(tc.rgb * l, tc.a);\n//gl_FragColor = vec4(l, tc.a);\n}\n";
J3D.ShaderSource.Selflit="//#name Selflit\n//#author bartekd\n//#description A very basic shader that uses a color and/or a texture and no lights\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * mMatrix * vec4(aVertexPosition, 1.0);\ngl_PointSize = 1.0;\nvTextureCoord = getTextureCoord(aTextureCoord);\n}\n//#fragment\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\ngl_FragColor = vec4(tc.rgba);\n}\n";
J3D.ShaderSource.Skybox="//#name Skybox\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nuniform float mid;\nvarying vec3 vVertexPosition;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * vec4(uEyePosition + aVertexPosition * mid, 1.0);\nvVertexPosition = aVertexPosition;\n}\n//#fragment\nuniform samplerCube uCubemap;\nvarying vec3 vVertexPosition;\nvoid main(void) {\ngl_FragColor = textureCube(uCubemap, vVertexPosition);\n}\n";J3D.ShaderSource.Vignette="//#name Vignette\n//#author bartekd\n//#vertex\n//#include BasicFilterVertex\n//#fragment\n//#include CommonFilterInclude\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec2 m = vec2(0.5, 0.5);\nfloat d = distance(m, vTextureCoord) * 1.0;\nvec3 c = texture2D(uTexture, vTextureCoord).rgb * (1.0 - d * d);\ngl_FragColor = vec4(c.rgb, 1.0);\n}\n";
J3D.ShaderSource.BasicFilterVertex="//#name BasicFilterVertex\n//#description A basic vertex shader for filters that use a full screen quad and have all the logic in fragment shader\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = vec4(aVertexPosition, 0.0, 1.0);\nvTextureCoord = aTextureCoord;\n}\n";J3D.ShaderSource.CommonFilterInclude="//#name CommonFilterInclude\n//#description Common uniforms and function for filters\nprecision mediump float;\nuniform float uTime;\nfloat whiteNoise(vec2 uv, float scale) {\nfloat x = (uv.x + 0.2) * (uv.y + 0.2) * (10000.0 + uTime);\nx = mod( x, 13.0 ) * mod( x, 123.0 );\nfloat dx = mod( x, 0.005 );\nreturn clamp( 0.1 + dx * 100.0, 0.0, 1.0 ) * scale;\n}\nfloat brightness(vec3 c) {\nreturn c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\n";
J3D.ShaderSource.CommonInclude="//#name CommonInclude\n//#description Collection of common uniforms, functions and structs to include in shaders (both fragment and vertex)\nprecision mediump float;\nprecision highp int;\nuniform float uTime;\nuniform mat4 mMatrix;\nuniform mat4 vMatrix;\nuniform mat3 nMatrix;\nuniform mat4 pMatrix;\nuniform vec3 uEyePosition;\nuniform vec4 uTileOffset;\nconst float PI = 3.14285714286;\nmat4 mvpMatrix() {\nreturn pMatrix * vMatrix * mMatrix;\n}\nmat4 mvMatrix() {\nreturn vMatrix * mMatrix;\n}\nfloat luminance(vec3 c) {\nreturn c.r * 0.299 + c.g * 0.587 + c.b * 0.114;\n}\nfloat brightness(vec3 c) {\nreturn c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\nvec2 getTextureCoord(vec2 uv) {\nreturn uv * uTileOffset.xy + uTileOffset.zw;\n}\nvec4 texture2DNormal(sampler2D texture, vec3 normal) {\nvec2 tc = vec2( asin(normal.x) / PI + 0.5, asin(normal.y) / PI + 0.5);\nreturn texture2D(texture, tc * uTileOffset.xy + uTileOffset.zw);\n}\n";
J3D.ShaderSource.Lights="//#name Lights\n//#description Collection of light equations\n//#description Requires CommonInclude\n//#description TODO Separate functions for directional, spot, point, hemi/phong models for all, separate dif func from spec\nstruct lightSource {\nint type;\nvec3 direction;     // used by directional and spotlight (global direction of the transfom)\nvec3 position;      // used by hemisphere, point, spotlight (it's the global position of the transform)\nvec3 color;         // used by d/p/s and hemisphere\nfloat intensity;    // used by spherical harmonics & d/p/s\nfloat angleFalloff; // used by hemisphere and spotlight (TODO: change to falloff)\nfloat angle;        // used by spotlight\n};\nuniform lightSource uLight0;\nuniform lightSource uLight1;\nuniform lightSource uLight2;\nuniform lightSource uLight3;\nconst float C1 = 0.429043;\nconst float C2 = 0.511664;\nconst float C3 = 0.743125;\nconst float C4 = 0.886227;\nconst float C5 = 0.247708;\n//const vec3 L00  = vec3( 0.871297,  0.875222,  0.864470);\n//const vec3 L1m1 = vec3( 0.175058,  0.245335,  0.312891);\n//const vec3 L10  = vec3( 0.034675,  0.036107,  0.037362);\n//const vec3 L11  = vec3(-0.004629, -0.029448, -0.048028);\n//const vec3 L2m2 = vec3(-0.120535, -0.121160, -0.117507);\n//const vec3 L2m1 = vec3( 0.003242,  0.003624,  0.007511);\n//const vec3 L20  = vec3(-0.028667, -0.024926, -0.020998);\n//const vec3 L21  = vec3(-0.077539, -0.086325, -0.091591);\n//const vec3 L22  = vec3(-0.161784, -0.191783, -0.219152);\nconst vec3 L00  = vec3( 0.078908,  0.043710,  0.054161);\nconst vec3 L1m1 = vec3( 0.039499,  0.034989,  0.060488);\nconst vec3 L10  = vec3(-0.033974, -0.018236, -0.026940);\nconst vec3 L11  = vec3(-0.029213, -0.005562,  0.000944);\nconst vec3 L2m2 = vec3(-0.011141, -0.005090, -0.012231);\nconst vec3 L2m1 = vec3(-0.026240, -0.022401, -0.047479);\nconst vec3 L20  = vec3(-0.015570, -0.009471, -0.014733);\nconst vec3 L21  = vec3( 0.056014,  0.021444,  0.013915);\nconst vec3 L22  = vec3( 0.021205, -0.005432, -0.030374);\nvec3 sphericalHarmonics(vec3 n, lightSource ls) {\nvec3 c =  C1 * L22 * (n.x * n.x - n.y * n.y) +\nC3 * L20 * n.z * n.z +\nC4 * L00 -\nC5 * L20 +\n2.0 * C1 * L2m2 * n.x * n.y +\n2.0 * C1 * L21  * n.x * n.z +\n2.0 * C1 * L2m1 * n.y * n.z +\n2.0 * C2 * L11  * n.x +\n2.0 * C2 * L1m1 * n.y +\n2.0 * C2 * L10  * n.z;\nc *= ls.intensity;\nreturn c;\n}\nvec3 hemisphere(vec4 p, vec3 n, float si, float sh, lightSource ls) {\nvec3 lv = normalize(ls.position - p.xyz);\nfloat dif = (dot(n, lv) * 0.5 + 0.5);\ndif = smoothstep(ls.angleFalloff, 1.0-ls.angleFalloff, dif);\nfloat spec = 0.0;\nif(si > 0.0) {\nvec3 eyed = normalize(uEyePosition - p.xyz);\nvec3 refd = reflect(-lv, n);\nspec = pow(max(dot(refd, eyed), 0.0), sh) * si;\n};\nreturn ls.color * dif + ls.color * spec;\n}\nvec3 phong(vec4 p, vec3 n, float si, float sh, lightSource ls){\nvec3 ld;\nif(ls.type == 1) ld = -ls.direction;\nelse ld = normalize(ls.position - p.xyz);\nfloat dif = max(dot(n, ld), 0.0);\nfloat spec = 0.0;\nif(si > 0.0) {\nvec3 eyed = normalize(uEyePosition - p.xyz);\nvec3 refd = reflect(-ld, n);\nspec = pow( (dot(refd, eyed) + 1.0) * 0.5, sh * 4.0) * si;\n}\nif(ls.type == 3) {\nfloat dd = dot(ld, -ls.direction);\nfloat ca = cos(ls.angle);\nfloat cf = cos(ls.angle + ls.angleFalloff);\nfloat spm = smoothstep(cf, ca, dd);\ndif *= spm;\nspec *= spm;\n}\ndif *= ls.intensity;\n//spec *= ls.intensity;\nreturn ls.color * dif + ls.color * spec;\n}\nvec3 singleLight(vec4 p, vec3 n, float si, float sh, lightSource ls) {\nif(ls.type == 0) {\nreturn ls.color;\n} else if(ls.type > 0 && ls.type < 4) {\nreturn phong(p, n, si, sh, ls);\n} else if(ls.type == 4) {\nreturn hemisphere(p, n, si, sh, ls);\n} else if(ls.type == 5) {\nreturn sphericalHarmonics(n, ls);\n} else {\nreturn vec3(0.0, 0.0, 0.0);\n}\n}\nvec3 computeLights(vec4 p, vec3 n, float si, float sh) {\nvec3 s = vec3(0.0, 0.0, 0.0);\ns += singleLight(p, n, si, sh, uLight0);\ns += singleLight(p, n, si, sh, uLight1);\ns += singleLight(p, n, si, sh, uLight2);\ns += singleLight(p, n, si, sh, uLight3);\nreturn s;\n}\n";
J3D.ShaderSource.Modifiers="//#name Modifiers\n//#description A collection of modifier functions for geometry (only bend for now)\nvec3 bend(vec3 ip, float ba, vec2 b, float o, float a) {\nvec3 op = ip;\nip.x = op.x * cos(a) - op.y * sin(a);\nip.y = op.x * sin(a) + op.y * cos(a);\nif(ba != 0.0) {\nfloat radius = b.y / ba;\nfloat onp = (ip.x - b.x) / b.y - o;\nip.z = cos(onp * ba) * radius - radius;\nip.x = (b.x + b.y * o) + sin(onp * ba) * radius;\n}\nop = ip;\nip.x = op.x * cos(-a) - op.y * sin(-a);\nip.y = op.x * sin(-a) + op.y * cos(-a);\nreturn ip;\n}\n";
J3D.ShaderSource.VertexInclude="//#name VertexInclude\n//#description Common attributes for a mesh - include this in a vertex shader so you don't rewrite this over and over again\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nattribute vec2 aTextureCoord;\nattribute vec2 aTextureCoord2;\nattribute vec4 aVertexColor;\n";J3D.Texture=function(a,b){var d=this;this.tex=gl.createTexture();this.autoLoad=!0;b||(b={});this.isVideo=this.loaded=!1;this.mipmap=b.mipmap!=null?b.mipmap:!0;this.flip=b.flip!=null?b.flip:!0;this.magFilter=b.magFilter||gl.LINEAR;this.minFilter=b.minFilter||b.mipmap?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR;this.isPowerOfTwo=function(){return d.src&&d.src.width>0&&d.src.height>0&&(d.src.width&d.src.width-1)==0&&(d.src.height&d.src.height-1)==0};var e=function(){if(!d.loaded){var e=d.src&&d.src.width>0&&
d.src.height>0&&(d.src.width&d.src.width-1)==0&&(d.src.height&d.src.height-1)==0;if(!d.wrapMode)d.wrapMode=b.wrapMode||e?gl.REPEAT:gl.CLAMP_TO_EDGE;gl.bindTexture(gl.TEXTURE_2D,d.tex);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,d.flip);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,d.src);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,d.magFilter);d.mipmap&&e&&gl.generateMipmap(gl.TEXTURE_2D);e?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,d.minFilter):gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MIN_FILTER,gl.LINEAR);e?(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,d.wrapMode),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,d.wrapMode)):(d.wrapMode!=gl.CLAMP_TO_EDGE&&console.warn("WARNING! Texture: "+a+" : only CLAMP_TO_EDGE wrapMode is supported for non-power-of-2 textures."),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE));gl.bindTexture(gl.TEXTURE_2D,null);if(b.onLoad)b.onLoad();d.loaded=
!0}},h=function(a){d.src=new Image;d.src.crossOrigin=b.cors||"";d.src.onload=function(){e()};d.src.src=a},g=function(a){d.isVideo=!0;d.src=document.createElement("video");d.src.src=a;d.src.preload="auto";d.src.loop=!1;var h=function(){d.src.removeEventListener("canplaythrough",h);b.autoPlay&&d.src.play();e()};d.src.addEventListener("ended",function(){if(b.onEnded)b.onEnded(d);if(b.loop)d.src.currentTime=0,d.src.play()},!1);d.src.addEventListener("canplaythrough",h,!1);d.src.load()};if(typeof a=="string"){var i=
a.substring(a.lastIndexOf(".")+1).toLowerCase();switch(i){case "jpg":case "png":case "gif":h(a);break;case "mp4":case "webm":case "ogv":g(a,i);break;default:b.image?h(a):b.video?g(a,i):console.log("Texture format not detected from source path and not specifed in params.")}}else if(a.getContext)d.src=a,e();else if(a instanceof HTMLVideoElement){d.isVideo=!0;d.src=a;var k=function(){d.src.removeEventListener("canplaythrough",k);e()};d.src.addEventListener("canplaythrough",k,!1)}else console.log("Video format not recognized: "+
typeof a),console.log(a instanceof HTMLVideoElement)};J3D.Texture.prototype.update=function(a){if(a||this.loaded&&this.isVideo)try{gl.bindTexture(gl.TEXTURE_2D,this.tex),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,this.src),gl.bindTexture(gl.TEXTURE_2D,null)}catch(b){}};J3D.Transform=function(a,b){var d=this,e=[];this.uid=b||0;this.name=a;this.numChildren=0;this.position=v3.ZERO();this.rotation=v3.ZERO();this.rotationq=quat4.create();this.useQuaternion=!1;this.scale=v3.ONE();this.worldPosition=vec3.create();this.worldForward=vec3.create();this.worldLeft=vec3.create();this.matrix=mat4.create();this.globalMatrix=mat4.create();this.normalMatrix=mat3.create();this.matrixMode=this._lockedMatrix=this.isStatic=!1;this.enabled=!0;this.animation=null;this.textureTile=v2.ONE();
this.textureOffset=v2.ZERO();this.disableDepthTest=!1;this.enable=function(){this.recurse(function(a){a.enabled=!0})};this.disable=function(){this.recurse(function(a){a.enabled=!1})};this.add=function(a){for(var b,i=0;i<arguments.length;i++)a=arguments[i],b||(b=a),e.indexOf(a)==-1&&e.push(a),a.parent=d,d.numChildren=e.length;return b};this.contains=function(a){return e.indexOf(a)>-1};this.recurse=function(a){a(d);for(var b=0;b<e.length;b++)e[b].recurse(a)};this.remove=function(a,b){if(d.contains(a))return e.splice(e.indexOf(a),
1),d.numChildren=e.length,a.parent=null,!0;else if(b)for(var i=0;i<e.length;i++){if(e[i].remove(a))return!0}else return!1};this.removeAll=function(){e=[];d.numChildren=0};this.childAt=function(a){return e[a]};this.path=function(){var a=[];a.push(d.name);for(var b=d.parent;b!=null;)a.push(b.name),b=b.parent;return a.reverse().join("/")}};
J3D.Transform.prototype.clone=function(){var a=new J3D.Transform;a.position=this.position.cp();a.rotation=this.rotation.cp();a.scale=this.scale.cp();a.isStatic=this.isStatic;a.renderer=this.renderer;a.geometry=this.geometry;a.camera=this.camera;a.light=this.light;a.collider=this.collider;return a};J3D.Transform.prototype.transformDirection=function(a){J3D.Performance.dirVecCalls++;var b=a.xyz();mat3.multiplyVec3(this.normalMatrix,b);return a.set(b[0],b[1],b[2])};
J3D.Transform.prototype.forward=function(){J3D.Performance.dirVecCalls++;return this.worldForward};J3D.Transform.prototype.left=function(){J3D.Performance.dirVecCalls++;return this.worldLeft};
J3D.Transform.prototype.updateWorld=function(a){if(!this._lockedMatrix){if(!this.matrixMode){var b=this.position,d=this.rotation,e=this.rotationq,h=this.scale;this.useQuaternion||quat4.fromEuler(d.x,d.y,d.z,e);mat4.fromRotationQTranslation(this.matrix,b.x,b.y,b.z,e[3],e[0],e[1],e[2],h.x,h.y,h.z);J3D.Performance.localMatrixUpdate++}a!=null?mat4.multiply(a.globalMatrix,this.matrix,this.globalMatrix):mat4.set(this.matrix,this.globalMatrix);mat4.toInverseMat3(this.globalMatrix,this.normalMatrix);mat3.transpose(this.normalMatrix);
vec3.set(this.worldForward,0,0,-1);mat3.multiplyVec3(this.normalMatrix,this.worldForward);vec3.set(this.worldLeft,-1,0,0);mat3.multiplyVec3(this.normalMatrix,this.worldLeft);mat4.extractTranslation(this.globalMatrix,this.worldPosition);if(this.isStatic)this._lockedMatrix=!0}};
J3D.Transform.prototype.getTileOffset=function(){var a,b;a=this.renderer.textureTile&&this.textureTile.isOne()?this.renderer.textureTile.xy():this.textureTile.xy();b=this.renderer.textureOffset&&this.textureOffset.isZero()?this.renderer.textureOffset.xy():this.textureOffset.xy();return a.concat(b)};J3D.Transform.prototype.find=function(a){a=a.split("/");for(var b=0;b<this.numChildren;b++)if(this.childAt(b).name==a[0])return a.length==1?this.childAt(b):this.childAt(b).find(a.slice(1).join("/"));return null};
J3D.Transform.prototype.updateInverseMat=function(){if(!this.inverseMat)this.inverseMat=mat4.create();mat4.inverse(this.globalMatrix,this.inverseMat)};J3D.Capabilities={webgl:function(){var a=null;try{var b=document.createElement("canvas");a=b.getContext("webgl")||b.getContext("experimental-webgl")}catch(d){console.log(d)}return a==null?(console.log("Context is null"),!1):!0}(),userStream:window.navigator.getUserMedia!=null||window.navigator.webkitGetUserMedia!=null,pointerLock:"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document,gamepad:!!navigator.webkitGamepads||!!navigator.webkitGetGamepads};J3D.Interactor=function(){var a=this;this.centerY=this.centerX=this.normY=this.normX=this.pageY=this.pageX=0;var b=function(b){a.pageX=b.pageX;a.pageY=b.pageY;a.normX=b.pageX/window.innerWidth;a.normY=b.pageY/window.innerHeight;a.centerX=a.normX*2-1;a.centerY=a.normY*2-1};this.destroy=function(){document.removeEventListener("mousemove",b,null)};document.addEventListener("mousemove",b,null)};J3D.PointerLock=function(){function a(){console.log("lockChange");document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e?(document.addEventListener("mousemove",b,!1),d.pointerLocked=!0,console.log("> locked!")):(document.removeEventListener("mousemove",b,!1),d.pointerLocked=!1,console.log("> unlocked!"))}function b(a){d.deltaX=a.movementX||a.mozMovementX||a.webkitMovementX||0;d.deltaY=a.movementY||a.mozMovementY||a.webkitMovementY||0}var d=this,
e;this.deltaY=this.deltaX=0;this.pointerLocked=!1;document.addEventListener("pointerlockchange",a,!1);document.addEventListener("mozpointerlockchange",a,!1);document.addEventListener("webkitpointerlockchange",a,!1);this.clear=function(){this.deltaX=this.deltaY=0};this.requestLock=function(a){a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock;a.requestPointerLock();e=a};this.releaseLock=function(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||
document.webkitExitPointerLock;document.exitPointerLock()}};J3D.UserStream=function(a){var b=window.navigator,d=!1,e=document.createElement("video");e.autoplay=!0;var h=function(a){console.log(a);throw J3D.Error.USER_STREAM_ERROR;},g=function(b){e.src=d?window.webkitURL.createObjectURL(b):b;a(e)};if(b.getUserMedia)b.getUserMedia({video:!0,audio:!1,captureDelay:2},g,h);else if(b.webkitGetUserMedia)d=!0,b.webkitGetUserMedia({audio:!1,video:!0},g,h);else throw J3D.Error.USER_STREAM_ERROR;};var m44=function(){this.array=[];this.identity()};m44.prototype.identity=function(){this.n11=1;this.n21=this.n14=this.n13=this.n12=0;this.n22=1;this.n32=this.n31=this.n24=this.n23=0;this.n33=1;this.n43=this.n42=this.n41=this.n34=0;this.n44=1};m44.prototype.ortho=function(a,b,d,e,h,g){var i,k,j;i=b-a;k=e-d;j=g-h;this.n11=2/i;this.n14=-((b+a)/i);this.n22=-2/k;this.n24=(e+d)/k;this.n33=2/j;this.n34=-((g+h)/j);this.makeArray()};
m44.prototype.perspective=function(a,b,d,e){a=d*Math.tan(a*Math.PI/360);var h=e-d;this.n11=d/(a*b);this.n22=d/a;this.n33=-(e+d)/h;this.n34=-(2*e*d)/h;this.n43=-1;this.n44=0;this.makeArray()};
m44.prototype.makeArray=function(){this.array[0]=this.n11;this.array[1]=this.n21;this.array[2]=this.n31;this.array[3]=this.n41;this.array[4]=this.n12;this.array[5]=this.n22;this.array[6]=this.n32;this.array[7]=this.n42;this.array[8]=this.n13;this.array[9]=this.n23;this.array[10]=this.n33;this.array[11]=this.n43;this.array[12]=this.n14;this.array[13]=this.n24;this.array[14]=this.n34;this.array[15]=this.n44};m44.prototype.toArray=function(){return this.array};var v2=function(a,b){this.x=a||0;this.y=b||0};v2.prototype.set=function(a,b){this.x=a||0;this.y=b||0};v2.prototype.xy=function(){return[this.x,this.y]};v2.prototype.isOne=function(){return this.x==1&&this.y==1};v2.prototype.isZero=function(){return this.x==0&&this.y==0};v2.ZERO=function(){return new v2(0,0)};v2.ONE=function(){return new v2(1,1)};v2.random=function(){return new v2(Math.random()*2-1,Math.random()*2-1)};var v3=function(a,b,d){J3D.Performance.numVectors++;J3D.Performance.vectorsPerFrame++;this.x=a||0;this.y=b||0;this.z=d||0};v3.prototype.set=function(a,b,d){this.x=a||0;this.y=b||0;this.z=d||0;return this};v3.prototype.fromArray=function(a){this.x=a[0];this.y=a[1];this.z=a[2];return this};v3.prototype.magSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};v3.prototype.mag=function(){return Math.sqrt(this.magSq())};v3.prototype.mul=function(a){return new v3(this.x*a,this.y*a,this.z*a)};
v3.prototype.mult=function(a){this.x*=a;this.y*=a;this.z*=a;return this};v3.prototype.neg=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this};v3.prototype.norm=function(){var a=1/this.mag();this.set(this.x*a,this.y*a,this.z*a);return this};v3.prototype.cp=function(){return new v3(this.x,this.y,this.z)};v3.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this};v3.prototype.add=function(a){return v3.add(this,a)};
v3.prototype.xyz=function(){J3D.Performance.numVectorArrays++;return[this.x,this.y,this.z]};v3.prototype.toUniform=function(){return this.xyz()};v3.add=function(a,b){var d=new v3(a.x,a.y,a.z);d.x+=b.x;d.y+=b.y;d.z+=b.z;return d};v3.prototype.add=function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this};v3.prototype.sub=function(a){return v3.sub(this,a)};v3.sub=function(a,b,d){d=d||new v3;d.x=a.x-b.x;d.y=a.y-b.y;d.z=a.z-b.z;return d};v3.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};
v3.cross=function(a,b){return new v3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};v3.calculateNormal=function(a,b,d,e){var h,g,i,k;h=a.x-b.x;g=a.y-b.y;b=a.z-b.z;i=a.x-d.x;k=a.y-d.y;a=a.z-d.z;return e.set(k*b-a*g,a*h-i*b,i*g-k*h)};v3.ZERO=function(){return new v3(0,0,0)};v3.ONE=function(){return new v3(1,1,1)};v3.RIGHT=function(){return new v3(1,0,0)};v3.UP=function(){return new v3(0,1,0)};v3.FORWARD=function(){return new v3(0,0,-1)};
v3.random=function(){return new v3(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1)};J3D.AnimationUtil={};J3D.AnimationUtil.createAnimationData=function(a){for(var b={properties:{}},d=0;d<a.length;d++)b.properties[a[d]]=[];return b};J3D.Color=function(a,b,d,e){J3D.Performance&&J3D.Performance.numColors++;var h=this;this.r=a||0;this.g=b||0;this.b=d||0;this.a=e||0;this.multiplyRGB=function(a){this.r*=a;this.g*=a;this.b*=a;return this};this.rgba=function(){J3D.Performance.numColorArrays++;return[h.r,h.g,h.b,h.a]};this.rgb=function(){J3D.Performance.numColorArrays++;return[h.r,h.g,h.b]};this.toUniform=function(a){return a==gl.FLOAT_VEC3?this.rgb():this.rgba()};this.toRGB=function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+
","+(this.b*255|0)+")"}};J3D.Color.fromHSL=function(a,b,d){if(b==0)d=b=a=d;else{var e=function(a,b,d){d<0&&(d+=1);d>1&&(d-=1);if(d<1/6)return a+(b-a)*6*d;if(d<0.5)return b;if(d<2/3)return a+(b-a)*(2/3-d)*6;return a},h=d<0.5?d*(1+b):d+b-d*b,g=2*d-h;d=e(g,h,a+1/3);b=e(g,h,a);a=e(g,h,a-1/3)}return new J3D.Color(d,b,a)};J3D.Color.fromHEX=function(a){a.indexOf("#")==0&&a.substring(1);a=a.indexOf("0x")==-1?"0x"+a:a;a=parseInt(a);return new J3D.Color((a>>16&255)/255,(a>>8&255)/255,(a&255)/255)};
J3D.Color.createWhite=function(){return new J3D.Color(1,1,1,1)};J3D.Color.white=new J3D.Color(1,1,1,1);J3D.Color.black=new J3D.Color(0,0,0,1);J3D.Color.red=new J3D.Color(1,0,0,1);J3D.Color.green=new J3D.Color(0,1,0,1);J3D.Color.blue=new J3D.Color(0,0,1,1);J3D.Error={};J3D.Error.NO_WEBGL_CONTEXT="No webgl context. Looks like your browser does not support webgl";J3D.Error.NO_CAMERA="Missing camera. Please assign a transform with a camera attached to engine.camera";J3D.Error.NO_BUILTIN_SHADER="Built-in shader not found: ";J3D.Error.UNKNOWN_COLLIDER_TYPE="Unrecognized collider type: ";J3D.Error.SHADER_COMPILE_ERROR="Shader compile error: ";J3D.Error.SHADER_LINK_ERROR="Shader linking error: ";J3D.Error.USER_STREAM_ERROR="UserStream not supported";J3D.GeometryUtil={randomNoise:function(a,b){for(var d=a.arraysByName[J3D.Mesh.VERTEX_POSITION],e=d.data,h=0;h<e.length;h++)e[h]+=b*Math.random();a.replaceArray(d,e)}};J3D.Intersection={};
J3D.Intersection.rayTest=function(a,b){if(!b.collider)return console.log("Intersection test failed. "+b.name+" has no collider."),!1;if(!J3D.Intersection.__tv1)J3D.Intersection.__tv1=new v3,J3D.Intersection.__tv2=new v3,J3D.Intersection.__tv3=new v3,J3D.Intersection.__tv4=new v3,J3D.Intersection.__tv5=new v3;switch(b.collider.type){case J3D.Collider.SPHERE:return J3D.Intersection.raySphere(a,b);case J3D.Collider.BOX:return J3D.Intersection.rayBox(a,b);case J3D.Collider.MESH:return J3D.Intersection.rayMesh(a,b);
default:throw J3D.Error.UNKNOWN_COLLIDER_TYPE+b.collider.type;}};
J3D.Intersection.rayMesh=function(a,b){if(!b.collider.mesh||!b.collider.mesh.vertexPositionBuffer)return console.log("Intersection test failed. "+b.name+" has no mesh defined or no vertex data in the mesh."),!1;if(b.collider.box){if(!J3D.Intersection.rayBox(a,b))return!1}else a.makeLocal(b);for(var d=b.collider.mesh.vertexPositionBuffer.data,e=b.collider.mesh.elements.data,h=!1,g=J3D.Intersection.__tv1,i=J3D.Intersection.__tv2,k=J3D.Intersection.__tv3,j=0;j<e.length;j+=3){var l=e[j+0]*3,m=e[j+1]*
3,p=e[j+2]*3;g.set(d[l],d[l+1],d[l+2]);i.set(d[m],d[m+1],d[m+2]);k.set(d[p],d[p+1],d[p+2]);if(h=h||J3D.Intersection.rayTriangle(a,g,i,k))break}return h};
J3D.Intersection.rayTriangle=function(a,b,d,e){var h=J3D.Intersection.__tv4,g=J3D.Intersection.__tv5;v3.calculateNormal(b,d,e,g);var i=v3.dot(g,a.localDirection);if(!(i<0))return!1;var k=v3.dot(g,b)-v3.dot(g,a.localOrigin);if(!(k<=0))return!1;k/=i;h.copyFrom(a.localDirection);h=h.norm().mult(k);h.add(a.localOrigin);Math.abs(g.x)>Math.abs(g.y)?Math.abs(g.x)>Math.abs(g.z)?(a=h.y-b.y,g=d.y-b.y,i=e.y-b.y,h=h.z-b.z,d=d.z-b.z,e=e.z-b.z):(a=h.x-b.x,g=d.x-b.x,i=e.x-b.x,h=h.y-b.y,d=d.y-b.y,e=e.y-b.y):Math.abs(g.y)>
Math.abs(g.z)?(a=h.x-b.x,g=d.x-b.x,i=e.x-b.x,h=h.z-b.z,d=d.z-b.z,e=e.z-b.z):(a=h.x-b.x,g=d.x-b.x,i=e.x-b.x,h=h.y-b.y,d=d.y-b.y,e=e.y-b.y);b=g*e-d*i;if(b==0)return!1;b=1/b;e=(a*e-h*i)*b;if(!(e>=0))return!1;b*=g*h-d*a;if(!(b>=0))return!1;if(!(1-e-b>=0))return!1;return k};
J3D.Intersection.raySphere=function(a,b){if(!b.collider.radius)return console.log("Intersection test failed. "+b.name+" has no radius defined."),!1;var d=b.collider.radius;d*=d;a.makeLocal(b);var e=J3D.Intersection.__tv1;v3.sub(b.collider.center,a.localOrigin,e);if(e.lengthSq<d)return!1;var h=v3.dot(e,a.localDirection);if(h<=0)return!1;b=d-(e.magSq()-h*h);if(b>=0)return Math.abs(h)-Math.sqrt(b);return!1};
J3D.Intersection.rayBox=function(a,b){if(!b.collider.box)return console.log("Intersection test failed. "+b.name+" has no box defined."),!1;var d=b.collider.box;a.makeLocal(b);var e=0,h=0,g=0,i=!0;a.localOrigin.x<d.minX?(e=d.minX-a.localOrigin.x,e/=a.localDirection.x,i=!1):a.localOrigin.x>d.maxX&&(e=d.maxX-a.localOrigin.x,e/=a.localDirection.x,i=!1);a.localOrigin.y<d.minY?(h=d.minY-a.localOrigin.y,h/=a.localDirection.y,i=!1):a.localOrigin.y>d.maxY&&(h=d.maxY-a.localOrigin.y,h/=a.localDirection.y,i=
!1);a.localOrigin.z<d.minZ?(g=d.minZ-a.localOrigin.z,g/=a.localDirection.z,i=!1):a.localOrigin.z>d.maxZ&&(g=d.maxZ-a.localOrigin.z,g/=a.localDirection.z,i=!1);if(i)return-1;i=0;h>e&&(i=1,e=h);g>e&&(i=2,e=g);switch(i){case 0:h=a.localOrigin.y+a.localDirection.y*e;if(h<d.minY||h>d.maxY)return!1;h=a.localOrigin.z+a.localDirection.z*e;if(h<d.minZ||h>d.maxZ)return!1;break;case 1:h=a.localOrigin.x+a.localDirection.x*e;if(h<d.minX||h>d.maxX)return!1;h=a.localOrigin.z+a.localDirection.z*e;if(h<d.minZ||h>
d.maxZ)return!1;break;case 2:h=a.localOrigin.x+a.localDirection.x*e;if(h<d.minX||h>d.maxX)return!1;h=a.localOrigin.y+a.localDirection.y*e;if(h<d.minY||h>d.maxY)return!1}return e};J3D.MathUtil={getBoundsAtDistance:function(a,b){var d=b*Math.tan(a.fov/180*Math.PI/2);return{w:d*(gl.viewportWidth/gl.viewportHeight),h:d}},calculateTangents:function(a){a.tangents=[];for(var b=[],d=[],e,h,g,i,k,j,l,m,p,r,o,n=0;n<a.tris.length;n+=3){var u=a.tris[n+0],q=a.tris[n+1],t=a.tris[n+2];j=new v3(a.vertices[u*3+0],a.vertices[u*3+1],a.vertices[u*3+2]);h=new v3(a.vertices[q*3+0],a.vertices[q*3+1],a.vertices[q*3+2]);l=new v3(a.vertices[t*3+0],a.vertices[t*3+1],a.vertices[t*3+2]);o=new v2(a.uv1[u*
2+0],a.uv1[u*2+1]);m=new v2(a.uv1[q*2+0],a.uv1[q*2+1]);r=new v2(a.uv1[t*2+0],a.uv1[t*2+1]);e=h.x-j.x;g=h.y-j.y;k=h.z-j.z;h=l.x-j.x;i=l.y-j.y;j=l.z-j.z;l=m.x-o.x;p=m.y-o.y;m=r.x-o.x;r=r.y-o.y;o=1/(l*r-m*p);r=new v3((r*e-p*h)*o,(r*g-p*i)*o,(r*k-p*j)*o);e=new v3((l*h-m*e)*o,(l*i-m*g)*o,(l*j-m*k)*o);b[u]||(b[u]=new v3);b[q]||(b[q]=new v3);b[t]||(b[t]=new v3);d[u]||(d[u]=new v3);d[q]||(d[q]=new v3);d[t]||(d[t]=new v3);b[u]=b[u].add(r);b[q]=b[q].add(r);b[t]=b[t].add(r);d[u]=d[u].add(e);d[q]=d[q].add(e);
d[t]=d[t].add(e)}for(n=0;n<a.vertices.length;n+=3)e=Math.floor(n/3),t=new v3(a.normals[n+0],a.normals[n+1],a.normals[n+2]),q=b[e],u=v3.sub(q,t.mul(v3.dot(t,q))).norm(),q=v3.dot(v3.cross(t,q),d[e])<0?-1:1,a.tangents.push(u.x,u.y,u.z,q)}};J3D.ParticleUtil={};J3D.ParticleUtil.insideCube=function(a,b,d){var e=new Float32Array(a*3);d=d||v3.ZERO();b/=2;for(var h=0;h<a*3;h+=3)e[h]=d.x+Math.random()*b*2-b+Math.random(),e[h+1]=d.y+Math.random()*b*2-b+Math.random(),e[h+2]=d.z+Math.random()*b*2-b+Math.random();return e};J3D.ParticleUtil.onSphere=function(a,b,d,e){var h=new Float32Array(a*3);e||v3.ZERO();d=d==null?1:d;for(e=0;e<a*3;e+=3){var g=v3.random().norm().mul(b+Math.random()*d);h[e]=g.x;h[e+1]=g.y;h[e+2]=g.z}return h};
J3D.ParticleUtil.randomColors=function(a,b,d){var e=new Float32Array(a*4);d=(d==null?1:d)-b;for(var h=0;h<a*4;h++)e[h]=b+Math.random()*d;return e};J3D.Performance=function(){return new function(){this.clear=function(){this.numVectorArrays=this.numColorArrays=this.localMatrixUpdate=this.programChaged=this.vectorsPerFrame=this.dirVecCalls=this.numTransforms=0};var a=function(a,d){return"<li>"+a+" "+d+"</li>"};this.printInfo=function(){var b="";b+=a("",J3D.getVersion());b+=a("Transforms",this.numTransforms);b+=a("Vectors/frame",this.vectorsPerFrame);b+=a("Vector array/frame",this.numVectorArrays);b+=a("Num color array/frame",this.numColorArrays);
b+=a("Vectors total",this.numVectors);b+=a("Matrices",this.numMatrices);b+=a("Program changed",this.programChaged);b+=a("Loc matrix updt",this.localMatrixUpdate);b+=a("Num colors",this.numColors);b+=a("Dir vector calls",this.dirVecCalls);this.domElement.innerHTML="<ul>"+b+"</ul>"};this.domElement=document.createElement("div");this.clear();this.numColors=this.numMatrices=this.numVectors=0}}();J3D.ShaderUtil={};J3D.ShaderUtil.setTexture=function(a,b,d,e){gl.activeTexture(33984+b);e.update&&e.update();if(e.tex)e=e.tex;gl.bindTexture(gl.TEXTURE_2D,e);gl.uniform1i(a.uniforms[d].location,b)};J3D.ShaderUtil.setTextureCube=function(a,b,d,e){gl.activeTexture(33984+b);gl.bindTexture(gl.TEXTURE_CUBE_MAP,e.tex);gl.uniform1i(a.uniforms[d].location,b)};
J3D.ShaderUtil.setAttributes=function(a,b){for(var d=0;d<b.arrays.length;d++){var e=b.arrays[d];a.attributes[e.name]!=null&&(gl.bindBuffer(gl.ARRAY_BUFFER,e.buffer),gl.vertexAttribPointer(a.attributes[e.name],e.itemSize,gl.FLOAT,!1,0,0))}};
J3D.ShaderUtil.setLights=function(a,b){for(var d=0;d<J3D.SHADER_MAX_LIGHTS;d++)b[d]&&a.uniforms["uLight"+d+".type"]?(gl.uniform1i(a.uniforms["uLight"+d+".type"].location,b[d].light.type),gl.uniform3fv(a.uniforms["uLight"+d+".direction"].location,b[d].worldForward),gl.uniform3fv(a.uniforms["uLight"+d+".color"].location,b[d].light.color.rgb()),gl.uniform3fv(a.uniforms["uLight"+d+".position"].location,b[d].worldPosition),gl.uniform1f(a.uniforms["uLight"+d+".intensity"].location,b[d].light.intensity),
gl.uniform1f(a.uniforms["uLight"+d+".angleFalloff"].location,b[d].light.angleFalloff),gl.uniform1f(a.uniforms["uLight"+d+".angle"].location,b[d].light.angle)):a.uniforms["uLight"+d+".type"]&&gl.uniform1i(a.uniforms["uLight"+d+".type"].location,J3D.NONE)};J3D.ShaderUtil.isTexture=function(a){return a==gl.SAMPLER_2D||a==gl.SAMPLER_CUBE};
J3D.ShaderUtil.getTypeName=function(a){switch(a){case gl.BYTE:return"BYTE (0x1400)";case gl.UNSIGNED_BYTE:return"UNSIGNED_BYTE (0x1401)";case gl.SHORT:return"SHORT (0x1402)";case gl.UNSIGNED_SHORT:return"UNSIGNED_SHORT (0x1403)";case gl.INT:return"INT (0x1404)";case gl.UNSIGNED_INT:return"UNSIGNED_INT (0x1405)";case gl.FLOAT:return"FLOAT (0x1406)";case gl.FLOAT_VEC2:return"FLOAT_VEC2 (0x8B50)";case gl.FLOAT_VEC3:return"FLOAT_VEC3 (0x8B51)";case gl.FLOAT_VEC4:return"FLOAT_VEC4 (0x8B52)";case gl.INT_VEC2:return"INT_VEC2   (0x8B53)";
case gl.INT_VEC3:return"INT_VEC3   (0x8B54)";case gl.INT_VEC4:return"INT_VEC4   (0x8B55)";case gl.BOOL:return"BOOL \t\t(0x8B56)";case gl.BOOL_VEC2:return"BOOL_VEC2  (0x8B57)";case gl.BOOL_VEC3:return"BOOL_VEC3  (0x8B58)";case gl.BOOL_VEC4:return"BOOL_VEC4  (0x8B59)";case gl.FLOAT_MAT2:return"FLOAT_MAT2 (0x8B5A)";case gl.FLOAT_MAT3:return"FLOAT_MAT3 (0x8B5B)";case gl.FLOAT_MAT4:return"FLOAT_MAT4 (0x8B5C)";case gl.SAMPLER_2D:return"SAMPLER_2D (0x8B5E)";case gl.SAMPLER_CUBE:return"SAMPLER_CUBE (0x8B60)";
default:return"Unknown ("+a.toString(16)+")"}};
J3D.ShaderUtil.setUniform=function(a,b,d){var e=b.uniforms[a];if(e)switch(d=d[a],d.toUniform&&(d=d.toUniform(e.type)),e.type){case gl.BYTE:gl.uniform1i(e.location,d);break;case gl.UNSIGNED_BYTE:gl.uniform1i(e.location,d);break;case gl.SHORT:gl.uniform1i(e.location,d);break;case gl.UNSIGNED_SHORT:gl.uniform1i(e.location,d);break;case gl.INT:gl.uniform1i(e.location,d);break;case gl.INT_VEC2:gl.uniform2iv(e.location,d);break;case gl.INT_VEC3:gl.uniform3iv(e.location,d);break;case gl.INT_VEC4:gl.uniform4iv(e.location,
d);break;case gl.UNSIGNED_INT:gl.uniform1i(e.location,d);break;case gl.FLOAT:gl.uniform1f(e.location,d);break;case gl.FLOAT_VEC2:gl.uniform2fv(e.location,d);break;case gl.FLOAT_VEC3:gl.uniform3fv(e.location,d);break;case gl.FLOAT_VEC4:gl.uniform4fv(e.location,d);break;case gl.BOOL:gl.uniform1i(e.location,d);break;case gl.BOOL_VEC2:gl.uniform2iv(e.location,d);break;case gl.BOOL_VEC3:gl.uniform3iv(e.location,d);break;case gl.BOOL_VEC4:gl.uniform4iv(e.location,d);break;case gl.FLOAT_MAT2:gl.uniformMatrix2fv(e.location,
!1,d);break;case gl.FLOAT_MAT3:gl.uniformMatrix3fv(e.location,!1,d);break;case gl.FLOAT_MAT4:gl.uniformMatrix4fv(e.location,!1,d);break;case gl.SAMPLER_2D:J3D.ShaderUtil.setTexture(b,e.texid,a,d);break;case gl.SAMPLER_CUBE:J3D.ShaderUtil.setTextureCube(b,e.texid,a,d);break;default:return"WARNING! Unknown uniform type ( 0x"+e.type.toString(16)+" )"}};
J3D.ShaderUtil.parseGLSL=function(a){a=a.split("\n");var b="",d="",e={};e.common="";e.includes=[];e.vertexIncludes=[];e.fragmentIncludes=[];for(var h=0,g=function(a,b){var d=b.indexOf(a);if(d>-1)return b.substring(d+a.length+1);return null},i=0;i<a.length;i++)if(a[i].indexOf("//#")>-1)if(a[i].indexOf("//#fragment")>-1)h++;else if(a[i].indexOf("//#vertex")>-1)h++;else{e.name=e.name||g("name",a[i]);var k=g("include",a[i]);if(k)switch(h){case 0:e.includes.push(k);break;case 1:e.vertexIncludes.push(k);
break;case 2:e.fragmentIncludes.push(k)}}else switch(k=a[i],k.indexOf("//")>-1&&(k=k.substring(0,k.indexOf("//"))),h){case 0:e.common+=k+"\n";break;case 1:b+=k+"\n";break;case 2:d+=k+"\n"}return new J3D.Shader(e.name||"Shader"+Math.round(Math.random()*1E3),b,d,e)};J3D.Time={};J3D.Time.time=0;J3D.Time.startTime=0;J3D.Time.timeOffset=0;J3D.Time.lastTime=0;J3D.Time.deltaTime=0;J3D.Time.tick=function(){var a=(new Date).getTime();if(J3D.Time.startTime==0)J3D.Time.startTime=a;if(J3D.Time.lastTime!=0)J3D.Time.deltaTime=a-J3D.Time.lastTime;J3D.Time.lastTime=a;J3D.Time.time=(a-J3D.Time.startTime)/1E3};J3D.Time.getTime=function(){J3D.Time.tick();return J3D.Time.deltaTime};J3D.Time.pause=function(){J3D.Time.timeOffset=(new Date).getTime()};
J3D.Time.resume=function(){J3D.Time.startTime+=(new Date).getTime()-J3D.Time.timeOffset;J3D.Time.lastTime=J3D.Time.deltaTime=0};J3D.Time.formatTime=function(a,b){if(!a)a=J3D.Time.time;var d=Math.floor(a%1*100),e=Math.floor(a)%60,h=Math.floor(a/60);d<10&&(d="0"+d);d==100&&(d="00");e<10&&(e="0"+e);h<10&&(h="0"+h);return b?h+":"+e+":"+d:h+":"+e};
