<html>

<head>
<title>017 | Benchmark | J3D</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<link rel="stylesheet" href="common/common.css"/>
<script type="text/javascript" src="common/common.js"></script>
<script type="text/javascript" src="js/Stats.js"></script>

<!-- J3DLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../build/j3d.js"></script>
<!-- J3DLIB -->

<script type="text/javascript" src="js/Persistence.js"></script>

<script id="blendFilter" type="x-shader/x-filter">
    //#name BlendFilter
    //#author bartekd

    //#include CommonFilterInclude

    //#vertex
    //#include BasicFilterVertex

    //#fragment
    uniform sampler2D uNewTexture;
    uniform sampler2D uOldTexture;

    varying vec2 vTextureCoord;

    void main(void) {
        vec4 n = texture2D(uNewTexture, vTextureCoord);
        vec2 c = vec2(0.5, 0.5) - vTextureCoord;
        vec4 o = texture2D(uOldTexture, vTextureCoord + c * 0.01);
        //o = vec4(mix(n.rgb, o.rgb, 0.99), 1.0);
        gl_FragColor = vec4(mix(n.rgb, o.rgb, 0.96), 1.0);
    }
</script>

<script>

    var engine, camera, camroot, post;
    var mx = 0, my = 0;
    var usepost = false;

    var greenCube, orangeCube, masterCube;
    var greenMat, orangeMat, simpleMat;
    var simpleMode = false;

    window.onload = function() {
        if (!J3D.Capabilities.webgl) return;

        J3D.Performance.domElement.setAttribute('class', 'perf');
        // document.body.appendChild(J3D.Performance.domElement);

        // stats = new Stats();
        // document.body.appendChild(stats.domElement);

        engine = new J3D.Engine();
        engine.setClearColor(J3D.Color.white);

        ambient = new J3D.Transform();
        ambient.light = new J3D.Light(J3D.AMBIENT);
        ambient.light.color = new J3D.Color(0.75, 0.75, 0.75, 1);

        light2 = new J3D.Transform();
        light2.light = new J3D.Light(J3D.DIRECT);
        light2.light.color = new J3D.Color(0.75, 0.75, 0.75, 1);
        light2.rotation.y = Math.PI / 2;

        camera = new J3D.Transform();
        camera.camera = new J3D.Camera({ fov:30 });
        camera.position.z = 12;

        camroot = new J3D.Transform();
        camroot.add(camera, light2);

        greenCube = new J3D.Transform();
        greenCube.geometry = J3D.Primitive.Cube(0.5, 0.5, 0.5);
//        greenCube.geometry = J3D.Primitive.Sphere(0.5, 8, 8);

        orangeCube = new J3D.Transform();
        orangeCube.geometry = J3D.Primitive.Cube(0.5, 0.5, 0.5);
//        orangeCube.geometry = J3D.Primitive.Sphere(0.5, 8, 8);

        greenMat = J3D.BuiltinShaders.fetch("Gouraud");
        greenMat.colorTexture = getTexture("#00b125", "#0b6001");
        greenMat.textureTile = new v2(2, 2);
        greenMat.hasColorTexture = true;

        orangeMat = J3D.BuiltinShaders.fetch("Gouraud");
        orangeMat.colorTexture = getTexture("#ff4600", "#ff9200");
        orangeMat.textureTile = new v2(2, 2);
        orangeMat.hasColorTexture = true;

        simpleMat = J3D.BuiltinShaders.fetch('Normal2Color');

        initScene();

        post = new J3D.Persistence(engine);
        post.blendFilter = new J3D.ShaderUtil.parseGLSL(document.getElementById("blendFilter").firstChild.nodeValue);

        document.onmousemove = function(e) {
            mx = ( e.clientX / window.innerWidth  ) * 2 - 1;
            my = ( e.clientY / window.innerHeight ) * 2 - 1;
        }

        function addCube() {
            var m = engine.scene.find("masterCube");
            var c = (Math.random() > 0.5) ? orangeCube.clone() : greenCube.clone();

            c.renderer = (simpleMode) ? simpleMat : (Math.random() > 0.5) ? orangeMat : greenMat;

            c.position = v3.random().norm().mul(4).add(v3.random().norm().mul(Math.random() * 4));
            c.rotation.x = Math.PI * 2 * Math.random();
            c.rotation.x = Math.PI * 2 * Math.random();
            c.rotXspeed = 0.8 + Math.random() * 0.8;
            c.rotYspeed = 0.8 + Math.random() * 0.8;
            m.add(c);
        }

        document.onkeydown = function(e) {
            var m = engine.scene.find("masterCube");

            switch (e.keyCode) {

                case 65: // A
                    addCube();
                    break;

                case 70:
                    m.recurse(function(c) {
                        var cm = (Math.random() > 0.5) ? orangeMat : greenMat;
                        c.renderer = (c.renderer == simpleMat) ? c.renderer = cm : c.renderer = simpleMat;
                    });

                    simpleMode = (m.renderer == simpleMat);

                    break;

                case 77: // M
                    for (var i = 0; i < 100; i++) addCube();
                    break;

                case 82: // R
                    if (m.numChildren > 0) m.remove(m.childAt(m.numChildren - 1));
                    break;

                case 81: // Q
                    m.removeAll();
                    break;

                case 80: // P
                    usepost = !usepost;
                    break;
            }

            var s = (engine.scene.numChildren - 3) + engine.scene.find("masterCube").numChildren;
            camera.position.z = 12 + s * 0.03;
        }

        draw();
    }

    function initScene() {
        var m = greenCube.clone();
        m.renderer = greenMat;
        m.name = "masterCube";
        m.rotXspeed = 0.1;
        m.rotYspeed = 0.1;

        engine.scene.add(m, light2, ambient, camroot);
        engine.scene.setCamera(camera);
    }

    function getTexture(ca, cb) {
        var c = document.createElement("canvas");
        c.width = 256;
        c.height = 256;
        var ctx = c.getContext("2d");

        ctx.fillStyle = ca;
        ctx.fillRect(0, 0, 128, 128);
        ctx.fillRect(128, 128, 128, 128);

        ctx.fillStyle = cb;
        ctx.fillRect(128, 0, 128, 128);
        ctx.fillRect(0, 128, 128, 128);

        return new J3D.Texture(c);
    }

    function draw() {
        requestAnimationFrame(draw);

        // J3D.Performance.clear();
        // stats.begin();

        var dsec = J3D.Time.deltaTime / 1000;

        camroot.rotation.y += dsec * 0.5;

        engine.scene.recurse(function(t) {
            // if t doesn't have rotXspeed it is not a cube
            if (t.rotXspeed) {
                t.rotation.x += dsec * t.rotXspeed;
                t.rotation.y += dsec * t.rotYspeed;
            }
        });

        (usepost) ? post.render() : engine.render();

        // stats.end();
        // J3D.Performance.printInfo();
    }

</script>
</head>
<body>
    <div id="details">
        <u>A</u> add cube<br> 
        <u>M</u> add 100 cubes<br> 
        <u>R</u> remove cube<br> 
        <u>Q</u> remove all cubes<br> 
        <u>F</u> toggle simple shader<br> 
        <u>P</u> toggle post effect
    </div>
</body>
</html>












