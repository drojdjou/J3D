<html>
<head>
<title>020 | Video Tracking | J3D</title>

<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<link rel="stylesheet" href="../demo/common/common.css"/>

<script type="text/javascript" src="../demo/common/common.js"></script>
<script type="text/javascript" src="../demo/js/TweenLite.min.js"></script>

<style type="text/css">

    #gl {
        display: block;
        width: 960px;
        height: 536px;
        overflow: hidden;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -480px;
        margin-top: -260px;
    }

    #markerContainer {
        position: absolute;
        top: 80px;
        left: 5px;
    }

    #markerContainer canvas {
        display: none;
    }

    #debug {
        position: absolute;
        top: 120px;
        left: 5px;
        font-size: 0.8em;
    }

</style>

<!-- J3DLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../build/j3d.js"></script>
<!-- J3DLIB -->

<script type="text/javascript">

    var path = "models/020/json/";

    var shadow, ball, camera, engine, post, canvas, mrkctx;
    var mx = 0, my = 0, ballHover;
    var debug;
    var trackingData = [];
    var lastFrame = 0;

    window.onload = function() {

        if (!J3D.Capabilities.webgl) {
            document.body.innerHTML = nowebglParagraph;
            return;
        }

        document.onmousemove = onMouseMove;
        document.onmousedown = onMouseDown;

        canvas = document.getElementById("gl");

        engine = new J3D.Engine(canvas, { resolution: 1 }, { alpha: true });
        engine.resize(canvas.width, canvas.height);

        console.log(engine.version());

        debug = document.getElementById("debug");
        framenum = document.getElementById("framenum");

        var assetsLoader = new J3D.AssetLoader();

        assetsLoader.addJSON("jsmeshes", path + "basketball.json");
        assetsLoader.addJSON("jsscene", path + "basketballScene.json");

        assetsLoader.addPlainText("tracking", "models/020/tracking/tracking-tabbed.txt");

        assetsLoader.addShader("trackingFilter", "models/020/shaders/TrackingFilter2DVideo.glsl");
        assetsLoader.addShader("shadowShader", "models/020/shaders/Shadow.glsl");

        assetsLoader.addTexture("shadowTex", path + "shadow.jpg");
//        assetsLoader.addTexture("ballTex", path + "basketball.png");
        assetsLoader.addTexture("videoTex", "models/020/video/base.webm", { loop: "loop", video: true });

        assetsLoader.load(function(a) {
            setup(a);
        });
    }

    var assetsComplete = false;

    function setup(assets) {

        // Firefox seems to call video 'canplaythrough' this each time it loops.
        // This is a temporary fix to this problem.
        if(assetsComplete) return;

        assetsComplete = true;

        var d = assets.tracking.split('\n');
        var fx, fy;
        for (var i = 0; i < d.length; i++) {
            var f = d[i].split('\t').splice(1, 2);
            if (!fx) {
                trackingData.push([ 0, 0 ]);
                fx = f[0];
                fy = f[1];
            } else {
                var dx = (f[0] - fx) / 960;
                var dy = (f[1] - fy) / 540;
                trackingData.push([ -dx, dy ]);
            }
        }

        var mrk = document.getElementById('marker');
        mrkctx = mrk.getContext('2d');
        mrkctx.fillStyle = "#000000";
        mrkctx.fillRect(0, 0, 256, 4);

        post = new J3D.Postprocess(engine);
        post.filter = assets.trackingFilter;
        post.filter.videoTexture = assets.videoTex;
        post.filter.markerBarStart = 1 - 536 / 540;


        assets.jsscene.path = path;
        J3D.Loader.parseJSONScene(assets.jsscene, assets.jsmeshes, engine);
//        engine.setClearColor(J3D.Color.white);

        ball = engine.scene.find("basketball/shadow/ball");

        ball.origPosition = ball.position.cp();
        ball.bounce = 0;
        ball.phase = 0;
//        ball.renderer = J3D.BuiltinShaders.fetch("Phong");
//        ball.renderer.colorTexture = assets.ballTex;
//        ball.renderer.hasColorTexture = true;

        camera = engine.scene.find("basketball/camera/cam");

        shadow = engine.scene.find("basketball/shadow");
        shadow.geometry.setTransparency(true, gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        shadow.renderer = assets.shadowShader;
        shadow.renderer.colorTexture = assets.shadowTex;
        shadow.target = shadow.position.cp();

        var harmonics = new J3D.Transform();
        harmonics.light = new J3D.Light(J3D.SPHERICAL_HARMONICS);
        engine.scene.add(harmonics);

        // video.play();

        render();
    }

    function onMouseMove(e) {
        mx = e.clientX;
        my = e.clientY;
    }

    function onMouseDown(e) {
        if (ballHover) {
            ball.bounce = 2;
            ball.phase = 0;

            shadow.target.x += 0.1 * (Math.random() * 2 - 1);
            shadow.target.z += 0.1 * (Math.random() * 2 - 1);
        }
    }

    var frameCount = 0;

    function render() {
        requestAnimationFrame(render);

        mrkctx.drawImage(post.filter.videoTexture.src, 0, 536, 256, 4, 0, 0, 256, 4);
        var pixels = mrkctx.getImageData(0, 0, 256, 16);
        var offset = 2 * 256 * 4;
        var f = 0;

        for (var i = 0; i < 16; i++) {
            if (pixels.data[offset + i * 4 * 16 + 4 * 4] > 128) {
                f += 1 << i;
            }
        }

        f--;
        f = Math.max(0, f);

//        if(f > lastFrame + 1) console.log('frame skipped', f, lastFrame);

        if(f == lastFrame) return;

        var d = trackingData[f];

//        framenum.innerHTML = "F: " + f;
//        debug.innerHTML = "D: " + d[0] + " : " + d[1];
        
        post.filter.offset = d;

        var r = J3D.Ray.fromMousePosition(mx + d[0] * 960, my - d[1] * 540, camera, {
            x: canvas.offsetLeft,
            y: canvas.offsetTop,
            width: 960,
            height: 540
        });

        ballHover = J3D.Intersection.rayTest(r, ball);
        document.body.style.cursor = (ballHover) ? "pointer" : "default";

        if (ball.bounce < 0.05) {
            ball.position.y = ball.origPosition.y;
            ball.bounce = 0;
        } else {
            ball.position.y = ball.origPosition.y + (Math.sin(ball.phase)) * ball.bounce;
            ball.phase += 0.006 * J3D.Time.deltaTime;
            ball.phase = ball.phase % Math.PI;
            ball.bounce *= 0.97;
            ball.rotation.x += ball.bounce * 0.01;
            ball.rotation.y += ball.bounce * 0.02;

            shadow.renderer.intensity = (ball.position.y - ball.origPosition.y) / 4;

            ball.position.y = Math.max(ball.position.y, ball.origPosition.y);

            shadow.position.x += (shadow.target.x - shadow.position.x) * 0.04;
            shadow.position.z += (shadow.target.z - shadow.position.z) * 0.04;
        }


        //if(frameCount % 200 == 0)
            post.render();
        //frameCount++;
        // engine.render();

        lastFrame = f;
    }

    function onMouseMove(e) {
        mx = e.pageX;
        my = e.pageY;
    }

</script>

</head>
<body>

<script>
    setLabels("020. Video Tracking", "Click on the ball!");
</script>

<canvas id="gl" width="960" height="540"></canvas>


<div id="debug"></div>

<div id="markerContainer">
    <canvas id="marker" width="256" height="4"></canvas>
    <div id="framenum"></div>
</div>


</body>
</html>