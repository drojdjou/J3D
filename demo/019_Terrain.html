<html> 
 
<head> 
<title>019 | Terrain shader | J3D</title>

<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"> 

<link rel="stylesheet" href="common/common.css"/>
<script type="text/javascript" src="common/common.js"></script>

<!-- J3DLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../build/j3d.js"></script>
<!-- J3DLIB -->
    
<script type="text/javascript" src="js/dat.gui.min.js"></script>

<script>
	var mx = 0, my = 0;

    var camroot, terrain, ground, water;
    var terShader;
	
	window.onload = function() {
		if(!J3D.Capabilities.webgl) return;

        properties = {
            beachLimit: 0.035,
            beachSmoothness: 0.01,
            rockLimit: 0.7,
            rockSmoothness: 0.15
        }

		gui = new dat.GUI({ autoPlace: false });


		gui.add(properties, 'beachLimit').min( 0.0 ).max( 1.0 );
        gui.add(properties, 'beachSmoothness').min( 0.0 ).max( 0.1 );
        gui.add(properties, 'rockLimit').min( 0.3 ).max( 1.0 );
        gui.add(properties, 'rockSmoothness').min( 0.0 ).max( 0.3 );


        gui.domElement.style.position = 'absolute';
        gui.domElement.style.bottom = '0px';
        gui.domElement.style.right = '0px';
		gui.domElement.style.margin = '0px';
		gui.domElement.style.zIndex = 200;
        document.body.appendChild( gui.domElement );

		engine = new J3D.Engine();

        J3D.Loader.loadGLSL("../demo/shaders/Terrain.glsl", function(s) {
			terShader = s;

			terShader.beachTex = new J3D.Texture("../demo/models/textures/terrain/sand.jpg");
			terShader.grassTex = new J3D.Texture("../demo/models/textures/terrain/grass.jpg");
            terShader.rockTex =  new J3D.Texture("../demo/models/textures/terrain/rock.jpg");

            terShader.textureTile = new v2(6,6);

			setup();
		});
    }

    function setup() {
		
		J3D.Loader.loadJSON("models/019/terrain.json", function(jsmeshes) {
			J3D.Loader.loadJSON("models/019/terrainScene.json", function(jsscene) {
				jsonScene = jsscene;
                jsscene.path = "models/019/";
				J3D.Loader.parseJSONScene(engine, jsscene, jsmeshes);

                camroot = engine.scene.find("camroot");
                terrain = engine.scene.find("terrain");

                water = engine.scene.find("terrain/water");
//                water.enabled = false;

                ground = engine.scene.find("terrain/ground");
                ground.geometry.calculateBoundingBox();
                var b = ground.geometry.boundingBox;
                terShader.heightLimits = [ b.minY, b.maxX ];
                ground.renderer = terShader;


				draw();
			})
		});

		document.onmousemove = onMouseMove;
	}
	
	function onMouseMove(e) {
		mx = e.clientX;
		my = e.clientY;
	}
	
	function draw() {
        terShader.beachLimit = properties.beachLimit;
        terShader.beachSmoothness = properties.beachSmoothness;

        terShader.rockLimit = properties.rockLimit;
        terShader.rockSmoothness = properties.rockSmoothness;

        terrain.rotation.y += J3D.Time.deltaTime * 0.0002;
        camroot.rotation.x = (my / window.innerHeight * 2 - 1) * 0.5;

        engine.render();
        requestAnimationFrame(draw);
	}
		
</script>
</head> 
<body>
</body> 
</html> 