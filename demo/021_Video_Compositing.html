<html>
<head>
<title>021 | Video Compositing | J3D</title>

<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<link rel="stylesheet" href="common/common.css"/>

<script type="text/javascript" src="common/common.js"></script>
<script type="text/javascript" src="js/TweenLite.min.js"></script>

<style type="text/css">

    #group video, #group canvas {
        position: absolute;
    }

    #group {
        position: absolute;
    }

    #videos {
        position: absolute;
        display: none;
    }

    #passepartout {
        position: absolute;
        display: block;
        overflow: hidden;
    }

    #debug {
        display: inline-block;
        background-color: #ffffff;
        position: absolute;
        top: 5px;
        left: 5px;
    }

</style>

<!-- J3DLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../build/j3d.js"></script>
<!-- J3DLIB -->

<script type="text/javascript">

    var path = "models/021/";

    var cv, zi = 1;
    var floor, mug, camera, engine, post, canvas;
    var mx, my;
    var debug;
    var mugHovered = false, mugDragged = false;
    var floorOrig, mugOrig;
    var startX, mugTargetX = 0;
    var ray = new J3D.Ray();

    // Hand sim
    var moveMargin = 30;
    var offsetX, offsetY;
    var handX = 0, handY = 0;
    var tHandX = 0, tHandY = 0;

    var vertBM = 0, horBM = 0;
    var vertBMSpeed = 0.005, horBMSpeed = 0.05;


    window.onload = function() {

        if (!J3D.Capabilities.webgl) {
            document.body.innerHTML = nowebglParagraph;
            return;
        }

        J3D.Performance.domElement.setAttribute('class', 'perf');
        document.body.appendChild(J3D.Performance.domElement);

        document.getElementById("v2").addEventListener('ended', function() {
            document.getElementById("v2").style.zIndex = 0;
            document.getElementById("v1").play();
        });

        document.getElementById("v3").addEventListener('ended', function() {
            document.getElementById("v3").style.zIndex = 0;
            document.getElementById("v1").play();
        });

        document.getElementById("v1").style.zIndex = 1;
        document.getElementById("gl").style.zIndex = 1000;

        debug = document.getElementById("debug");

        setTimeout(swapVideo, 8000 + Math.random() * 4000);

        startGL();
    }

    function startGL() {

        canvas = document.getElementById("gl");

        engine = new J3D.Engine(canvas, { resolution: 1 }, {
            alpha: true
        });

        engine.resize(canvas.width, canvas.height);
        var assetsLoader = new J3D.AssetLoader();

        assetsLoader.addJSON("jsmeshes", path + "mug.json");
        assetsLoader.addJSON("jsscene", path + "mugScene.json");

        assetsLoader.addTexture("shadowTex", "models/021/floor.png");
        assetsLoader.load(function(a) {
            setup(a);
        });
    }

    function setup(assets) {

        offsetX = window.innerWidth * 0.5 - canvas.width * 0.5 + moveMargin * 0.5;
        offsetY = window.innerHeight * 0.5 - canvas.height * 0.5 + moveMargin * 0.5;

        console.log(offsetX, offsetY);

        var vids = document.getElementById('videos');
        vids.style.left = offsetX + 'px';
        vids.style.top = offsetY + 'px';
        vids.style.display = 'block';

        var ppt = document.getElementById('passepartout');
        ppt.style.width = (canvas.width - moveMargin) + 'px';
        ppt.style.height = (canvas.height - moveMargin) + 'px';


        assets.jsscene.path = path;
        J3D.Loader.parseJSONScene(engine, assets.jsscene, assets.jsmeshes);
        engine.setClearColor(new J3D.Color(0, 0, 0, 0));

        mug = engine.scene.find("floor/mug");

        camera = engine.scene.find("camera");
        // camera.rotation.z = Math.PI;

        floor = engine.scene.find("floor");
        floor.geometry.setTransparency(true, gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        floor.renderer = J3D.BuiltinShaders.fetch("Selflit");
        floor.renderer.colorTexture = assets.shadowTex;
        floor.renderer.hasColorTexture = true;

        floorOrig = floor.position.cp();
        mugOrig = mug.position.cp();
        mugOrigRot = mug.rotation.cp();

        var harmonics = new J3D.Transform();
        harmonics.light = new J3D.Light(J3D.SPHERICAL_HARMONICS);
        engine.scene.add(harmonics);

        document.onmousemove = onMouseMove;
        document.onmousedown = onMouseDown;
        document.onmouseup = onMouseUp;

        render();
    }

    function onMouseMove(e) {
        mx = e.clientX;
        my = e.clientY;
        tHandX = (mx / window.innerWidth * 2 - 1 ) * -1;
        tHandY = (my / window.innerHeight * 2 - 1 ) * -1;
    }

    function onMouseDown(e) {
        if (mugHovered) {
            startX = (mx - canvas.offsetLeft) / 1024;

            TweenLite.to(mug.position, 0.3, { ease:Power2.easeOut, y:mugOrig.y + 3 });
            TweenLite.to(mug.rotation, 0.3, { ease:Power2.easeOut, z:mugOrigRot.z + 0.2 });
            TweenLite.to(floor.rotation, 0.3, { ease:Power2.easeOut, y:floor.rotation.y + (Math.random() - 0.5) });

            mugDragged = true;
        }
    }

    function onMouseUp(e) {
        if (mugDragged) {
            mugDragged = false;

            TweenLite.to(mug.position, 0.2, { ease:Power2.easeOut, y:mugOrig.y });
            TweenLite.to(mug.rotation, 0.1, { ease:Power2.easeInOut, z:mugOrigRot.z - 0.1 });
            TweenLite.to(mug.rotation, 0.2, { ease:Power2.easeOut, delay:0.08, z:mugOrigRot.z });
        }
    }

    function render() {
        requestAnimationFrame(render);

        J3D.Performance.clear();

        handX += (tHandX - handX) / 10;
        handY += (tHandY - handY) / 10;

        var mt = -moveMargin * 0.5 + moveMargin * 0.5 * handY + Math.sin(vertBM) * moveMargin * 0.25;
        var ml = -moveMargin * 0.5 + moveMargin * 0.5 * handX + Math.sin(horBM) * moveMargin * 0.25;

        vertBM += vertBMSpeed;
        horBM += horBMSpeed;

        mt = Math.max(-moveMargin, mt);
        ml = Math.max(-moveMargin, ml);

        mt = Math.min(0, mt);
        ml = Math.min(0, ml);

        var g = document.getElementById('group');
        g.style.marginTop = mt;
        g.style.marginLeft = ml;

        ray = J3D.Ray.fromMousePosition(mx, my, camera, {
            x: offsetX,
            y: offsetY,
            width: 1024,
            height: 576
        }, ray);

        mugHovered = J3D.Intersection.rayTest(ray, mug);
        document.body.style.cursor = (mugHovered) ? "pointer" : "default";

        if (mugDragged) {
            mugTargetX += (mx / window.innerWidth - startX) * -3;
            mugTargetX = Math.max(-12, mugTargetX);
            mugTargetX = Math.min(12, mugTargetX);

            floor.position.x = floorOrig.x + mugTargetX;
            floor.rotation.y += (mx / window.innerWidth - 0.5) * -0.2;
        }

        engine.render();

//        J3D.Performance.printInfo();
    }


    function swapVideo() {
        zi++;

        document.getElementById("v1").pause();

        var vn = "v" + (2 + zi % 2);

        document.getElementById(vn).style.zIndex = zi;
        document.getElementById(vn).play();

        setTimeout(swapVideo, 8000 + Math.random() * 4000);


    }

</script>

</head>
<body>

<script>
    setLabels("021. Video Compositing", "Click and drag the cup to move it around");
</script>

<div id="videos">
    <div id="passepartout">
        <div id="group">
            <video id="v2" width="1024" height="576" src="models/021/in.mp4"></video>
            <video id="v3" width="1024" height="576" src="models/021/out.mp4"></video>
            <video id="v1" width="1024" height="576" src="models/021/loop.mp4" autoplay loop></video>
            <canvas id="gl" width="1024" height="576"></canvas>
        </div>
    </div>
</div>

<div id="debug"></div>


</body>
</html>